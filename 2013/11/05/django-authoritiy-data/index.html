<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="5_8DTmIiEq4gFvNAfxAD6TsGOgrMAjp8lQFQvfA6zZc" />
  <title>Django authority data</title>
  <meta name="author" content="Serafeim Papastefanos">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="http://spapas.github.io/favicon.png" rel="icon">
  <link href="http://spapas.github.io/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="http://spapas.github.io/theme/js/modernizr-2.0.js"></script>
  <script src="http://spapas.github.io/theme/js/ender.js"></script>
  <script src="http://spapas.github.io/theme/js/octopress.js" type="text/javascript"></script>

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://spapas.github.io/">/var/</a></h1>
    <h2>Various programming stuff</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>



<ul class="main-navigation">
    <li class="active">
    <a href="http://spapas.github.io/category/django.html">Django</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/flask.html">Flask</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/git.html">Git</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/pelican.html">Pelican</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/spring.html">Spring</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/wagtail.html">Wagtail</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Django authority data</h1>
      <p class="meta"><time datetime="2013-11-05T14:20:00" pubdate>Τρι 05 Νοέμβριος 2013</time></p>
</header>

  <div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#defining-authorities" id="id2">Defining authorities</a><ul>
<li><a class="reference internal" href="#using-groups" id="id3">Using&nbsp;groups</a></li>
<li><a class="reference internal" href="#by-storing-the-authority-to-the-session" id="id4">By storing the authority to the&nbsp;session</a></li>
<li><a class="reference internal" href="#by-using-a-custom-user-profile" id="id5">By using a Custom User&nbsp;Profile</a></li>
<li><a class="reference internal" href="#getting-the-authority-of-the-user-has-to-be-dry" id="id6">Getting the authority of the user has to be <span class="caps">DRY</span></a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-authority-data" id="id7">Adding authority&nbsp;data</a></li>
<li><a class="reference internal" href="#conclusion" id="id8">Conclusion</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>One common requirement in an organization is to separate users in authorities (meaning departments / units / branches etc)
and each authority have its own data. So users belonging to the &quot;Athens Branch&quot; won&#8217;t be able to
edit data submitted from users of the &quot;Thessaloniki&nbsp;Branch&quot;.</p>
<p>This is a special case of the more general row-level-security in which each instance of a domain object will
have an <span class="caps">ACL</span>. Row-level-security would need a many-to-many relation between object instances and authorities, something
that would be overkill in our&nbsp;case.</p>
<p>Authority data is also a more general case of the user-data meaning that each user can have access
to data that he inserts in the system. Implementing user-data is easy using the techniques we will present&nbsp;below.</p>
<p>We have to notice that the django permissions do not support our requirements since they define security for all instances of a&nbsp;model.</p>
</div>
<div class="section" id="defining-authorities">
<h2><a class="toc-backref" href="#id2">Defining&nbsp;authorities</a></h2>
<p>In order to have custom authorities I propose first of all to add an Authority model that would define the authority. Even if
your authorities only have a name I believe that adding the Authority model would be beneficial.
Now, there are many ways to separate normal django users (<tt class="docutils literal">django.contrib.auth.models.User</tt>) to&nbsp;authorities:</p>
<div class="section" id="using-groups">
<h3><a class="toc-backref" href="#id3">Using&nbsp;groups</a></h3>
<p>Just define a <tt class="docutils literal">django.contrib.auth.models.Group</tt> for each authority and add the users to the groups you want using the django-admin.
Your Authority model would have an one-to-one relation with the <tt class="docutils literal">django.contrib.auth.models.Group</tt> so you will be able to find out the other
information of the authority (since django groups only have&nbsp;names).</p>
<p>Now you can just get the groups for the user and find out his authorities. This could lead to problems when users belong to django groups
that are not related to authorities so you must filter these out (for instance by checking which groups actually have a corresponding&nbsp;Authority).</p>
</div>
<div class="section" id="by-storing-the-authority-to-the-session">
<h3><a class="toc-backref" href="#id4">By storing the authority to the&nbsp;session</a></h3>
<p>When the user logs in you can add an attribute to the session that would save the authority of the user. To do that, you should define
a custom middleware that checks to see if there is an authority attribute to the session and if not it will do whatever it needs to find it and set it.
An example is&nbsp;this:</p>
<pre class="code literal-block">
class CustomAuthorityMiddleware:
  def process_request(self, request):
    if not request.session.get('authority'):
      authority = get_the_authority(request.user)
      request.session['authority']=authority
</pre>
<p>This way, whenever you want to find out the authority of the user you just check the&nbsp;session.</p>
</div>
<div class="section" id="by-using-a-custom-user-profile">
<h3><a class="toc-backref" href="#id5">By using a Custom User&nbsp;Profile</a></h3>
<p>Just create a <a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/auth/customizing/#extending-the-existing-user-model">django user profile</a> and add to it a <tt class="docutils literal">ForeignKey</tt> to your Authority&nbsp;model:</p>
<pre class="code literal-block">
class Profile(models.Model):
  user = models.OneToOneField('django.auth.User')
  authority = models.ForeignKey('authorities.Authority', blank=True, null=True )

class Authority(models.Model):
  id = models.IntegerField(primary_key = True)
  name = models.CharField(max_length=64, )
  auth_type = models.CharField(max_length=16, )
</pre>
<p>You can get the authority of the user through <tt class="docutils literal">request.user.profile.authority</tt>.</p>
</div>
<div class="section" id="getting-the-authority-of-the-user-has-to-be-dry">
<h3><a class="toc-backref" href="#id6">Getting the authority of the user has to be <span class="caps">DRY</span></a></h3>
<p>Whatever method you use to define the authorities of your users you have to remember that it is very
important to define somewhere a function that will return the authority (or authorities) of a
user. You need to define a function even in the simple case in which your function would just return <tt class="docutils literal">request.user.profile.authority</tt>.
This will greatly help you when you wish to add some logic to this, for instance &quot;quickly disable users belonging to Authority X
or temporary move users from Authority Y to authority&nbsp;Z&quot;.</p>
<p>Let us suppose that you have defined a <tt class="docutils literal">get_user_authority</tt> function. Also, you need to define a <tt class="docutils literal">has_access</tt> function
that would decide if a users/request has access to a particular object. This also needs to be <span class="caps">DRY</span>.</p>
</div>
</div>
<div class="section" id="adding-authority-data">
<h2><a class="toc-backref" href="#id7">Adding authority&nbsp;data</a></h2>
<p>To define authority data you have to add a field to your model that would define its authority, for instance like&nbsp;this:</p>
<pre class="code literal-block">
class AuthorityData(models.Model):
  authority = models.ForeignKey('authorities.Authority', editable=False,)
</pre>
<p>This field should not be editable (at least by your end users) because they shouldn&#8217;t be able to change the authority of the data they&nbsp;insert.</p>
<p>If you want to have user-data then just add a <tt class="docutils literal"><span class="pre">models.ForeignKey('django.auth.User',</span> editable=False)</tt></p>
<p>Now, your Create and Update Class Based Views have to pass the request to your forms and also your Detail and Update <span class="caps">CBV</span> should allow only getting
objects that belong to the authority of the&nbsp;user:</p>
<pre class="code literal-block">
class AuthorityDataCreateView(CreateView):
  model=models.AuthorityData

  def get_form_kwargs(self):
      kwargs = super(AuthorityDataCreateView, self).get_form_kwargs()
      kwargs.update({'request': self.request})
      return kwargs

class AuthorityDataDetailView(DetailView):
  def get_object(self, queryset=None):
      obj = super(AuthorityDataDetailView, self).get_object(queryset)
      if if not user_has_access(obj, self.request):
          raise Http404(u&quot;Access Denied&quot;)
      return obj

class AuthorityDataUpdateView(UpdateView):
  model=models.AuthorityData

  def get_form_kwargs(self):
      kwargs = super(AuthorityDataUpdateView, self).get_form_kwargs()
      kwargs.update({'request': self.request})
      return kwargs

  def get_object(self, queryset=None):
      obj = super(AuthorityDataUpdateView, self).get_object(queryset)
      if if not user_has_access(obj, self.request):
          raise Http404(u&quot;Access Denied&quot;)
      return obj
</pre>
<p>Your ModelForm can now use the request to get the Authority and set it (don&#8217;t forget
that you should not use <tt class="docutils literal">Meta.exclude</tt> but instead use <tt class="docutils literal">Meta.include</tt>!):</p>
<pre class="code literal-block">
class AuthorityDataModelForm(forms.ModelForm):
    class Meta:
      model = models.AuthorityData
      exclude = ('authority',)

    def __init__(self, *args, **kwargs):
      self.request = kwargs.pop('request', None)
      super(ActionModelForm, self).__init__(*args, **kwargs)


    def save(self, force_insert=False, force_update=False, commit=True):
      obj = super(AuthorityDataModelForm, self).save(commit=False)
      if obj:
          obj.authority = get_user_authority(self.request)
          obj.save()
      return obj
</pre>
<p>The previous work fine for Create/Detail/Update CBVs but not for ListsViews. List views querysets
and in general all queries to the object have to be filtered through&nbsp;authority.</p>
<pre class="code literal-block">
class AuthorityDataListView(ListView):
  def get_queryset(self):
    queryset = super(AuthorityDataModelForm, self).get_queryset()
    return queryset.filter(authority = get_user_authority(request))
</pre>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id8">Conclusion</a></h2>
<p>Using the above techniques we can define authority (or just user) data. Your AuthorityData should
have a <tt class="docutils literal">ForeignKey</tt> to your Authority  and you have configure your queries, ModelForms and CBVs
to use that. If you have more than one models that belong to an authority and want to stay <span class="caps">DRY</span> then you&#8217;d need
to define all the above as <a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/class-based-views/mixins/">mixins</a>.</p>
</div>
</div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Serafeim Papastefanos</span>
  </span>
<time datetime="2013-11-05T14:20:00" pubdate>Τρι 05 Νοέμβριος 2013</time>  <span class="categories">
    <a class="category" href="http://spapas.github.io/tag/django.html">django</a>
    <a class="category" href="http://spapas.github.io/tag/python.html">python</a>
    <a class="category" href="http://spapas.github.io/tag/security.html">security</a>
  </span>
</p><div class="sharing">
</div>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
  </section>
</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="http://spapas.github.io/2014/09/15/django-non-html-responses/">Django non-HTML responses</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2014/06/30/rest-flask-mongodb-heroku/">Implementing a simple, Heroku-hosted REST service using Flask and mongoDB</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2014/04/11/django-generic-formviews-for-objects/">Django generic FormViews for objects</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2014/02/13/wagtail-tutorial/">A Wagtail tutorial</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2013/12/24/django-dynamic-forms/">Django dynamic forms</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="http://spapas.github.io/category/django.html">django</a></li>
        <li><a href="http://spapas.github.io/category/flask.html">flask</a></li>
        <li><a href="http://spapas.github.io/category/git.html">git</a></li>
        <li><a href="http://spapas.github.io/category/pelican.html">pelican</a></li>
        <li><a href="http://spapas.github.io/category/spring.html">spring</a></li>
        <li><a href="http://spapas.github.io/category/wagtail.html">wagtail</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="http://spapas.github.io/tag/pelican.html">pelican</a>,    <a href="http://spapas.github.io/tag/spring.html">spring</a>,    <a href="http://spapas.github.io/tag/rest.html">rest</a>,    <a href="http://spapas.github.io/tag/cbv.html">cbv</a>,    <a href="http://spapas.github.io/tag/git.html">git</a>,    <a href="http://spapas.github.io/tag/java.html">java</a>,    <a href="http://spapas.github.io/tag/flask.html">flask</a>,    <a href="http://spapas.github.io/tag/heroku.html">heroku</a>,    <a href="http://spapas.github.io/tag/forms.html">forms</a>,    <a href="http://spapas.github.io/tag/github-pages.html">github-pages</a>,    <a href="http://spapas.github.io/tag/ldap.html">ldap</a>,    <a href="http://spapas.github.io/tag/spring-security.html">spring-security</a>,    <a href="http://spapas.github.io/tag/python.html">python</a>,    <a href="http://spapas.github.io/tag/mongodb.html">mongodb</a>,    <a href="http://spapas.github.io/tag/authentication.html">authentication</a>,    <a href="http://spapas.github.io/tag/class-based-views.html">class-based-views</a>,    <a href="http://spapas.github.io/tag/rst.html">rst</a>,    <a href="http://spapas.github.io/tag/branching.html">branching</a>,    <a href="http://spapas.github.io/tag/github.html">github</a>,    <a href="http://spapas.github.io/tag/windows.html">windows</a>,    <a href="http://spapas.github.io/tag/wagtail.html">wagtail</a>,    <a href="http://spapas.github.io/tag/django.html">django</a>,    <a href="http://spapas.github.io/tag/githubio.html">github.io</a>,    <a href="http://spapas.github.io/tag/static-html.html">static-html</a>,    <a href="http://spapas.github.io/tag/security.html">security</a>  </section>



</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2013-2014  - Serafeim Papastefanos -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44750952-1', 'auto');
    ga('send', 'pageview');
    </script>
	<script type="text/javascript">
	  var disqus_shortname = 'spapas-github-io';
          var disqus_identifier = '/2013/11/05/django-authoritiy-data/';
          var disqus_url = 'http://spapas.github.io/2013/11/05/django-authoritiy-data/';
          var disqus_title = 'Django authority&nbsp;data';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
</body>
</html>
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="5_8DTmIiEq4gFvNAfxAD6TsGOgrMAjp8lQFQvfA6zZc" />
  <title>Django model auditing</title>
  <meta name="author" content="Serafeim Papastefanos">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="../../../../favicon.png" rel="icon">
  <link href="../../../../theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="../../../../theme/js/modernizr-2.0.js"></script>
  <script src="../../../../theme/js/ender.js"></script>
  <script src="../../../../theme/js/octopress.js" type="text/javascript"></script>

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="../../../../">/var/</a></h1>
    <h2>Various programming stuff</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>



<ul class="main-navigation">
    <li >
    <a href="../../../../category/css.html">Css</a>
    </li>
    <li class="active">
    <a href="../../../../category/django.html">Django</a>
    </li>
    <li >
    <a href="../../../../category/flask.html">Flask</a>
    </li>
    <li >
    <a href="../../../../category/git.html">Git</a>
    </li>
    <li >
    <a href="../../../../category/pelican.html">Pelican</a>
    </li>
    <li >
    <a href="../../../../category/python.html">Python</a>
    </li>
    <li >
    <a href="../../../../category/spring.html">Spring</a>
    </li>
    <li >
    <a href="../../../../category/wagtail.html">Wagtail</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Django model auditing</h1>
      <p class="meta"><time datetime="2014-01-21T14:20:00" pubdate>Τρι 21 Ιανουάριος 2014</time></p>
</header>

  <div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#adding-simple-auditing-functionality-ourselves" id="id2">Adding simple auditing functionality&nbsp;ourselves</a></li>
<li><a class="reference internal" href="#example" id="id3">Example</a><ul>
<li><a class="reference internal" href="#models-py" id="id4">models.py</a></li>
<li><a class="reference internal" href="#conclusion" id="id5">Conclusion</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>An auditing trail is a common requirement in most non-trivial applications. Organizations
need to know <em>when</em> and <em>by whom</em> each change was made. In this post we will see three
different solution in order to have such functionality in Django: doing it ourselves,
using django-simplehistory and using&nbsp;django-reversion.</p>
</div>
<div class="section" id="adding-simple-auditing-functionality-ourselves">
<h2><a class="toc-backref" href="#id2">Adding simple auditing functionality&nbsp;ourselves</a></h2>
<p>A simple way to actually do auditing is to keep four extra fields in our models:
<tt class="docutils literal">created_by</tt>, <tt class="docutils literal">created_on</tt>, <tt class="docutils literal">modified_by</tt> and <tt class="docutils literal">modified_on</tt>. The first two
will be filled when the model instance is created while the latter two will be
changed whenever the model instance is saved. Sometimes, these four fields is the
only info required (for a first level&nbsp;auditing)!</p>
<p>Let&#8217;s create an abstract model that could be used as a base for&nbsp;auditing:</p>
<pre class="code literal-block">
from django.conf import settings
from django.db import models

class Auditable(models.Model):
    created_on = models.DateTimeField(auto_now_add = True)
    created_by = models.ForeignKey(settings.AUTH_USER_MODEL, related_name='created_by')

    modified_on = models.DateTimeField(auto_now = True)
    modified_by = models.ForeignKey(settings.AUTH_USER_MODEL, related_name='modified_by')

    class Meta:
        abstract = True
</pre>
<p>Models inheriting from <tt class="docutils literal">Auditable</tt> will contain their datetime of creation and modification
which will be automatically filled using the very usefull <tt class="docutils literal">auto_now_add_</tt> (which will
set the current datetime when the model instance is created) and <tt class="docutils literal">auto_now_</tt> (which will
set the current datetime when the model instance is&nbsp;modified).</p>
<p>Such models will also have two foreign keys to <tt class="docutils literal">User</tt>, one for the user
that created the and one of the user that modified them. The problem with these two fields
is that they cannot be filled automatically (like the datetimes) because the user that
actually did create/change the objects must be&nbsp;provided!</p>
<p>Since I am really fond of CBVs I will present a simple mixin that can be used with CreateView
and UpdateView and does exactly&nbsp;that:</p>
<pre class="code literal-block">
class AuditableMixin(object,):
    def form_valid(self, form, ):
        if not form.instance.created_by:
            form.instance.created_by = self.request.user
        form.instance.modified_by = self.request.user
        return super(AuditableMixin, self).form_valid(form)
</pre>
<p>The above mixin overrides the <tt class="docutils literal">form_valid</tt> method of <tt class="docutils literal">CreateView</tt> and <tt class="docutils literal">UpdateView</tt>:
First it checks if the object is created (if it is created it won&#8217;t be saved in the
database yet thus it won&#8217;t have an id) in order to set the <tt class="docutils literal">created_by</tt> attribute to
the current user. After that it will set the <tt class="docutils literal">modified_by</tt> attribute of the object to
the current user. Finally, it will call the next <tt class="docutils literal">form_valid</tt> method to do whatever
is required (save the model instance and redirect to <tt class="docutils literal">success_url</tt> by&nbsp;default).</p>
<p>The views using <tt class="docutils literal">AuditableMixin</tt> should allow only logged in users (or else an
exception will be thrown). Also, don&#8217;t forget to exclude the <tt class="docutils literal">created_by</tt> and <tt class="docutils literal">modified_by</tt>
fields from your model form (<tt class="docutils literal">created_on</tt> and <tt class="docutils literal">modified_on</tt> will automatically be&nbsp;excluded).</p>
</div>
<div class="section" id="example">
<h2><a class="toc-backref" href="#id3">Example</a></h2>
<p>Let&#8217;s see a simple example of the above simple abstract model and&nbsp;mixin:</p>
<div class="section" id="models-py">
<h3><a class="toc-backref" href="#id4">models.py</a></h3>
</div>
<div class="section" id="conclusion">
<h3><a class="toc-backref" href="#id5">Conclusion</a></h3>
</div>
</div>
</div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">Serafeim Papastefanos</span>
  </span>
<time datetime="2014-01-21T14:20:00" pubdate>Τρι 21 Ιανουάριος 2014</time>  <span class="categories">
    <a class="category" href="../../../../tag/django.html">django</a>
    <a class="category" href="../../../../tag/python.html">python</a>
    <a class="category" href="../../../../tag/auditing.html">auditing</a>
  </span>
</p><div class="sharing">
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="../../../../2014/01/21/django-model-auditing/" data-via="" data-counturl="../../../../2014/01/21/django-model-auditing/" >Tweet</a>
</div>    </footer>
  </article>

</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="../../../../2014/12/16/change-bootstrap-material-primary-color/">Change the primary color of bootstrap material design</a>
      </li>
      <li class="post">
          <a href="../../../../2014/10/23/retrieve-gmail-blocked-attachments/">Retrieving Gmail blocked attachments</a>
      </li>
      <li class="post">
          <a href="../../../../2014/09/15/django-non-html-responses/">Django non-HTML responses</a>
      </li>
      <li class="post">
          <a href="../../../../2014/06/30/rest-flask-mongodb-heroku/">Implementing a simple, Heroku-hosted REST service using Flask and mongoDB</a>
      </li>
      <li class="post">
          <a href="../../../../2014/04/11/django-generic-formviews-for-objects/">Django generic FormViews for objects</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="../../../../category/css.html">css</a></li>
        <li><a href="../../../../category/django.html">django</a></li>
        <li><a href="../../../../category/flask.html">flask</a></li>
        <li><a href="../../../../category/git.html">git</a></li>
        <li><a href="../../../../category/pelican.html">pelican</a></li>
        <li><a href="../../../../category/python.html">python</a></li>
        <li><a href="../../../../category/spring.html">spring</a></li>
        <li><a href="../../../../category/wagtail.html">wagtail</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="../../../../tag/pelican.html">pelican</a>,    <a href="../../../../tag/google.html">google</a>,    <a href="../../../../tag/nodejs.html">node.js</a>,    <a href="../../../../tag/spring.html">spring</a>,    <a href="../../../../tag/rest.html">rest</a>,    <a href="../../../../tag/design.html">design</a>,    <a href="../../../../tag/auditing.html">auditing</a>,    <a href="../../../../tag/gmail.html">gmail</a>,    <a href="../../../../tag/git.html">git</a>,    <a href="../../../../tag/java.html">java</a>,    <a href="../../../../tag/flask.html">flask</a>,    <a href="../../../../tag/less.html">less</a>,    <a href="../../../../tag/heroku.html">heroku</a>,    <a href="../../../../tag/forms.html">forms</a>,    <a href="../../../../tag/github-pages.html">github-pages</a>,    <a href="../../../../tag/ldap.html">ldap</a>,    <a href="../../../../tag/spring-security.html">spring-security</a>,    <a href="../../../../tag/css.html">css</a>,    <a href="../../../../tag/python.html">python</a>,    <a href="../../../../tag/mongodb.html">mongodb</a>,    <a href="../../../../tag/authentication.html">authentication</a>,    <a href="../../../../tag/class-based-views.html">class-based-views</a>,    <a href="../../../../tag/rst.html">rst</a>,    <a href="../../../../tag/branching.html">branching</a>,    <a href="../../../../tag/github.html">github</a>,    <a href="../../../../tag/windows.html">windows</a>,    <a href="../../../../tag/wagtail.html">wagtail</a>,    <a href="../../../../tag/django.html">django</a>,    <a href="../../../../tag/githubio.html">github.io</a>,    <a href="../../../../tag/static-html.html">static-html</a>,    <a href="../../../../tag/cbv.html">cbv</a>,    <a href="../../../../tag/security.html">security</a>,    <a href="../../../../tag/boostrap-material-design.html">boostrap-material-design</a>  </section>



</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2013-2014  - Serafeim Papastefanos -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44750952-1', 'auto');
    ga('send', 'pageview');
    </script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
</body>
</html>
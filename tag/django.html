<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="5_8DTmIiEq4gFvNAfxAD6TsGOgrMAjp8lQFQvfA6zZc" />
  <title>/var/ - django</title>
  <meta name="author" content="Serafeim Papastefanos">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="http://spapas.github.io/favicon.png" rel="icon">
  <link href="http://spapas.github.io/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="http://spapas.github.io/theme/js/modernizr-2.0.js"></script>
  <script src="http://spapas.github.io/theme/js/ender.js"></script>
  <script src="http://spapas.github.io/theme/js/octopress.js" type="text/javascript"></script>

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://spapas.github.io/">/var/</a></h1>
    <h2>Various programming stuff</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>



<ul class="main-navigation">
    <li >
    <a href="http://spapas.github.io/category/css.html">Css</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/django.html">Django</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/flask.html">Flask</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/git.html">Git</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/pelican.html">Pelican</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/python.html">Python</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/spring.html">Spring</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/wagtail.html">Wagtail</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div class="blog-index">
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2015/01/21/django-model-auditing/">Django model auditing</a>
      </h1>
      <p class="meta"><time datetime="2015-01-21T14:20:00" pubdate>Τετ 21 Ιανουάριος 2015</time></p>
</header>

  <div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id5">Introduction</a></li>
<li><a class="reference internal" href="#adding-simple-auditing-functionality-ourselves" id="id6">Adding simple auditing functionality&nbsp;ourselves</a></li>
<li><a class="reference internal" href="#example" id="id7">Example</a><ul>
<li><a class="reference internal" href="#models-py" id="id8">models.py</a></li>
<li><a class="reference internal" href="#forms-py" id="id9">forms.py</a></li>
<li><a class="reference internal" href="#views-py" id="id10">views.py</a></li>
<li><a class="reference internal" href="#urls-py" id="id11">urls.py</a></li>
<li><a class="reference internal" href="#templates" id="id12">templates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-django-simple-history" id="id13">Using django-simple-history</a><ul>
<li><a class="reference internal" href="#installation" id="id14">Installation</a></li>
<li><a class="reference internal" href="#id1" id="id15">Example</a></li>
<li><a class="reference internal" href="#usage" id="id16">Usage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-django-reversion" id="id17">Using django-reversion</a><ul>
<li><a class="reference internal" href="#id2" id="id18">Installation</a></li>
<li><a class="reference internal" href="#id3" id="id19">Example</a></li>
<li><a class="reference internal" href="#id4" id="id20">Usage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion" id="id21">Conclusion</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id5">Introduction</a></h2>
<p>An auditing trail is a common requirement in most non-trivial applications. Organizations
need to know <em>who</em> did the change, <em>when</em> it was done and <em>what</em> was actually changed.
In this post we will see three
different solution in order to add this functionality in Django: doing it ourselves,
using django-simple-history and using&nbsp;django-reversion.</p>
</div>
<div class="section" id="adding-simple-auditing-functionality-ourselves">
<h2><a class="toc-backref" href="#id6">Adding simple auditing functionality&nbsp;ourselves</a></h2>
<p>A simple way to actually do auditing is to keep four extra fields in our models:
<tt class="docutils literal">created_by</tt>, <tt class="docutils literal">created_on</tt>, <tt class="docutils literal">modified_by</tt> and <tt class="docutils literal">modified_on</tt>. The first two
will be filled when the model instance is created while the latter two will be
changed whenever the model instance is saved. So we only have <em>who</em> and <em>whe</em>.
Sometimes, these are enough so let&#8217;s see how easy it is to implement it in&nbsp;django.</p>
<p>We&#8217;ll need an abstract model that could be used as a base class for models that need&nbsp;auditing:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Auditable</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">created_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;created_by&#39;</span><span class="p">)</span>

    <span class="n">modified_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">modified_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;modified_by&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="bp">True</span>
</pre></div>
<p>Models inheriting from <tt class="docutils literal">Auditable</tt> will contain their datetime of creation and modification
which will be automatically filled using the very usefull <tt class="docutils literal">auto_now_add_</tt> (which will
set the current datetime when the model instance is created) and <tt class="docutils literal">auto_now_</tt> (which will
set the current datetime when the model instance is&nbsp;modified).</p>
<p>Such models will also have two foreign keys to <tt class="docutils literal">User</tt>, one for the user
that created the and one of the user that modified them. The problem with these two fields
is that they cannot be filled automatically (like the datetimes) because the user that
actually did create/change the objects must be&nbsp;provided!</p>
<p>Since I am really fond of CBVs I will present a simple mixin that can be used with CreateView
and UpdateView and does exactly&nbsp;that:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">AuditableMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">,):</span>
    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">created_by</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">modified_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">AuditableMixin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>The above mixin overrides the <tt class="docutils literal">form_valid</tt> method of <tt class="docutils literal">CreateView</tt> and <tt class="docutils literal">UpdateView</tt>:
First it checks if the object is created (if it is created it won&#8217;t be saved in the
database yet thus it won&#8217;t have an id) in order to set the <tt class="docutils literal">created_by</tt> attribute to
the current user. After that it will set the <tt class="docutils literal">modified_by</tt> attribute of the object to
the current user. Finally, it will call the next <tt class="docutils literal">form_valid</tt> method to do whatever
is required (save the model instance and redirect to <tt class="docutils literal">success_url</tt> by&nbsp;default).</p>
<p>The views using <tt class="docutils literal">AuditableMixin</tt> should allow only logged in users (or else an
exception will be thrown). Also, don&#8217;t forget to exclude the <tt class="docutils literal">created_by</tt> and <tt class="docutils literal">modified_by</tt>
fields from your model form (<tt class="docutils literal">created_on</tt> and <tt class="docutils literal">modified_on</tt> will automatically be&nbsp;excluded).</p>
</div>
<div class="section" id="example">
<h2><a class="toc-backref" href="#id7">Example</a></h2>
<p>Let&#8217;s see a simple example of creating a small django application using the previously defined abstract model and&nbsp;mixin:</p>
<div class="section" id="models-py">
<h3><a class="toc-backref" href="#id8">models.py</a></h3>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="kn">from</span> <span class="nn">auditable.models</span> <span class="kn">import</span> <span class="n">Auditable</span>


<span class="k">class</span> <span class="nc">Book</span><span class="p">(</span><span class="n">Auditable</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s">&quot;book_list&quot;</span><span class="p">)</span>
</pre></div>
<p>In the above we suppose that the <tt class="docutils literal">Auditable</tt> abstract model is imported from the
<tt class="docutils literal">auditable.models</tt> module and that a view named <tt class="docutils literal">book_list</tt> that shows all books&nbsp;exists.</p>
</div>
<div class="section" id="forms-py">
<h3><a class="toc-backref" href="#id9">forms.py</a></h3>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">ModelForm</span>


<span class="k">class</span> <span class="nc">BookForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Book</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;author&#39;</span><span class="p">]</span>
</pre></div>
<p>Show only <tt class="docutils literal">name</tt> and <tt class="docutils literal">author</tt> fields (and not the auditable fields) in the <tt class="docutils literal">Book ModelForm</tt>.</p>
</div>
<div class="section" id="views-py">
<h3><a class="toc-backref" href="#id10">views.py</a></h3>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.views.generic.edit</span> <span class="kn">import</span> <span class="n">CreateView</span><span class="p">,</span> <span class="n">UpdateView</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">ListView</span>

<span class="kn">from</span> <span class="nn">auditable.views</span> <span class="kn">import</span> <span class="n">AuditableMixin</span>

<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Book</span>
<span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">BookForm</span>


<span class="k">class</span> <span class="nc">BookCreateView</span><span class="p">(</span><span class="n">AuditableMixin</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Book</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">BookForm</span>


<span class="k">class</span> <span class="nc">BookUpdateView</span><span class="p">(</span><span class="n">AuditableMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Book</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">BookForm</span>


<span class="k">class</span> <span class="nc">BookListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Book</span>
</pre></div>
<p>We import the <tt class="docutils literal">AuditableMixin</tt> from <tt class="docutils literal">auditable.views</tt> and make our Create and Update views
inherit from this mixin also in addition to <tt class="docutils literal">CreateView</tt> and <tt class="docutils literal">UpdateView</tt>. Pay attention that our
mixin is placed <em>before</em> CreateView in order to call <tt class="docutils literal">form_valid</tt> in the proper order: When multiple
inheritance is used like this python will check each class from left to right to find the proper method
and call it. For example, in our <tt class="docutils literal">BookCreateView</tt>, when the <tt class="docutils literal">form_valid</tt> method is called, python
will first check if <tt class="docutils literal">BookCreateView</tt> has a <tt class="docutils literal">form_valid</tt> method. Since it does not, it will check
if <tt class="docutils literal">AuditableMixin</tt> has a <tt class="docutils literal">form_valid</tt> method and call it. Now, we are calling the <tt class="docutils literal"><span class="pre">super(...).form_valid()</span></tt> in the
<tt class="docutils literal">AuditableMixin</tt> <tt class="docutils literal">form_valid</tt>, so the <tt class="docutils literal">form_valid</tt> of <tt class="docutils literal">CreateView</tt> will <em>also</em> be&nbsp;called.</p>
<p>A simple <tt class="docutils literal">ListView</tt> is also added to just show the info on all&nbsp;books.</p>
</div>
<div class="section" id="urls-py">
<h3><a class="toc-backref" href="#id11">urls.py</a></h3>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>

<span class="kn">from</span> <span class="nn">views</span> <span class="kn">import</span> <span class="n">BookCreateView</span><span class="p">,</span> <span class="n">BookUpdateView</span><span class="p">,</span> <span class="n">BookListView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^accounts/login/$&#39;</span><span class="p">,</span> <span class="s">&#39;django.contrib.auth.views.login&#39;</span><span class="p">,</span> <span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^accounts/logout/$&#39;</span><span class="p">,</span> <span class="s">&#39;django.contrib.auth.views.logout&#39;</span><span class="p">,</span> <span class="p">),</span>

    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^create/$&#39;</span><span class="p">,</span> <span class="n">BookCreateView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;create_book&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^update/(?P&lt;pk&gt;\d+)/$&#39;</span><span class="p">,</span> <span class="n">BookUpdateView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;update_book&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">BookListView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;book_list&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
<p>Just add the previously defined Create/Update/List views along with a login/logout&nbsp;views.</p>
</div>
<div class="section" id="templates">
<h3><a class="toc-backref" href="#id12">templates</a></h3>
<p>You&#8217;ll need four&nbsp;templates:</p>
<ul class="simple">
<li>books/book_list.html: Show the list of&nbsp;books</li>
<li>books/book_form.html: Show the book editing&nbsp;form</li>
<li>registration/login.html: Login&nbsp;form</li>
<li>registration/logout.html: Logout&nbsp;message</li>
</ul>
</div>
</div>
<div class="section" id="using-django-simple-history">
<h2><a class="toc-backref" href="#id13">Using&nbsp;django-simple-history</a></h2>
<p><a class="reference external" href="https://github.com/treyhunner/django-simple-history">django-simple-history</a>  can be used to not only store the user and date of each modification
but a different version for each modification. To do that, for every model that is registered
to be used with django-simple-history, it wil create a second table in
the database hosting all versions (historical records) of that model. As we can understand this is really powerfull
since we can see exactly what was changed and also do normal <span class="caps">SQL</span> queries on&nbsp;that!</p>
<div class="section" id="installation">
<h3><a class="toc-backref" href="#id14">Installation</a></h3>
<p>To use django-simple-history in a project, after we do a <tt class="docutils literal">pip install <span class="pre">django-simple-history</span></tt>,
we just need to add it to <tt class="docutils literal">INSTALLED_APPS</tt> and
add the <tt class="docutils literal">simple_history.middleware.HistoryRequestMiddleware</tt> to the <tt class="docutils literal">MIDDLEWARE_CLASSES</tt> list.</p>
<p>Finally, to keep the historical records for a model, just add an instace of <tt class="docutils literal">HistoricalRecords</tt> to this&nbsp;model.</p>
</div>
<div class="section" id="id1">
<h3><a class="toc-backref" href="#id15">Example</a></h3>
<p>For example, our previously defined <tt class="docutils literal">Book</tt> model will be modified like&nbsp;this:</p>
<div class="highlight"><pre>class SHBook(models.Model):
    name = models.CharField(max_length=128)
    author = models.CharField(max_length=128)

    def get_absolute_url(self):
        return reverse(&quot;shbook_list&quot;)

    history = HistoricalRecords()
</pre></div>
<p>When we run <tt class="docutils literal">python manage.py makemigrations</tt> and <tt class="docutils literal">migrate</tt> this, we&#8217;ll see that beyond the table for SHBook, a table for HistoricalSHBook will be&nbsp;created:</p>
<pre class="code literal-block">
Migrations for 'sample':
  0002_historicalshbook_shbook.py:
    - Create model HistoricalSHBook
    - Create model SHBook
</pre>
<p>Let&#8217;s see the schema of&nbsp;historicalshbook:</p>
<pre class="code literal-block">
CREATE TABLE &quot;sample_historicalshbook&quot; (
    &quot;id&quot; integer NOT NULL,
    &quot;name&quot; varchar(128) NOT NULL,
    &quot;author&quot; varchar(128) NOT NULL,
    &quot;history_id&quot; integer NOT NULL PRIMARY KEY AUTOINCREMENT,
    &quot;history_date&quot; datetime NOT NULL,
    &quot;history_type&quot; varchar(1) NOT NULL,
    &quot;history_user_id&quot; integer NULL REFERENCES &quot;auth_user&quot; (&quot;id&quot;)
);
</pre>
<p>So we see that it has the <em>same</em> fields as with <tt class="docutils literal">SHBook</tt> (<tt class="docutils literal">id, name, author</tt>) with the addition of
the primary key (<tt class="docutils literal">history_id</tt>) of this historical record, the date and user that did the change
(<tt class="docutils literal">history_date</tt>, <tt class="docutils literal">history_user_id</tt>) and the type of the record (created / update /&nbsp;delete).</p>
<p>So, just by adding a <tt class="docutils literal">HistoricalRecords()</tt> attribute to our model definition we&#8217;ll get complete auditing
for the instance of that&nbsp;model</p>
</div>
<div class="section" id="usage">
<h3><a class="toc-backref" href="#id16">Usage</a></h3>
<p>To find out information about the historical records we&#8217;ll just use the <tt class="docutils literal">HistoricalRecords()</tt> attribute
of that&nbsp;model:</p>
<p>For example, running <tt class="docutils literal">SHBook.history.filter(id=1)</tt> will return all historical records of the book with
<tt class="docutils literal">id = 1</tt>. For each one of them we have can use the&nbsp;following:</p>
<ul class="simple">
<li>get the user that made the change through the <tt class="docutils literal">history_user</tt> attribute</li>
<li>get the date of the change through the <tt class="docutils literal">history_date</tt> attribute</li>
<li>get the type of the change through the <tt class="docutils literal">history_type</tt> attribute (and the corresponding <tt class="docutils literal">get_history_type_dispaly</tt>)</li>
<li>get a model instance as it was then through the <tt class="docutils literal">history_object</tt> attribute (in order to <tt class="docutils literal">save()</tt> it and revert to this&nbsp;version)</li>
</ul>
</div>
</div>
<div class="section" id="using-django-reversion">
<h2><a class="toc-backref" href="#id17">Using&nbsp;django-reversion</a></h2>
<p><a class="reference external" href="https://github.com/etianen/django-reversion">django-reversion</a>  offers more or less the same functionality of django-simple-history by following a different philosophy:
Instead of creating an extra table holding the history records for each model, it insteads converts all the fields of each model
to json and stores that <span class="caps">JSON</span> in the database in a text&nbsp;field.</p>
<p>This has the advantage that no extra tables are created to the database but the disadvantage that you can&#8217;t easily query
your historical records. So you may choose one or the other depending on your actual&nbsp;requirements.</p>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id18">Installation</a></h3>
<p>To use django-reversion in a project, after we do a <tt class="docutils literal">pip install <span class="pre">django-reversion</span></tt>,
we just need to add it to <tt class="docutils literal">INSTALLED_APPS</tt> and
add the <tt class="docutils literal">reversion.middleware.RevisionMiddleware</tt> to the <tt class="docutils literal">MIDDLEWARE_CLASSES</tt> list.</p>
<p>In order to save the revisions of a model, you need to register this model to django-reversion. This can be
done either through the django-admin, by inheriting the admin class of that model from <tt class="docutils literal">reversion.VersionAdmin</tt>
or, if you don&#8217;t want to use the admin by <tt class="docutils literal">reversion.register</tt> decorator.</p>
</div>
<div class="section" id="id3">
<h3><a class="toc-backref" href="#id19">Example</a></h3>
<p>To use django-reversion to keep track of changes to <tt class="docutils literal">Book</tt> we can modify it like&nbsp;this:</p>
<div class="highlight"><pre>@reversion.register
class RBook(models.Model):
    name = models.CharField(max_length=128)
    author = models.CharField(max_length=128)

    def get_absolute_url(self):
        return reverse(&quot;rbook_list&quot;)
</pre></div>
<p>django-reversion uses two tables in the database to keep track of revisions: <tt class="docutils literal">revision</tt> and <tt class="docutils literal">version</tt>. Let&#8217;s
take a look at their&nbsp;schemata:</p>
<pre class="code literal-block">
.schema reversion_revision
CREATE TABLE &quot;reversion_revision&quot; (
    &quot;id&quot; integer NOT NULL PRIMARY KEY AUTOINCREMENT,
    &quot;manager_slug&quot; varchar(200) NOT NULL,
    &quot;date_created&quot; datetime NOT NULL,
    &quot;comment&quot; text NOT NULL,
    &quot;user_id&quot; integer NULL REFERENCES &quot;auth_user&quot; (&quot;id&quot;)
);

.schema reversion_version
CREATE TABLE &quot;reversion_version&quot; (
    &quot;id&quot; integer NOT NULL PRIMARY KEY AUTOINCREMENT,
    &quot;object_id&quot; text NOT NULL,
    &quot;object_id_int&quot; integer NULL,
    &quot;format&quot; varchar(255) NOT NULL,
    &quot;serialized_data&quot; text NOT NULL,
    &quot;object_repr&quot; text NOT NULL,
    &quot;content_type_id&quot; integer NOT NULL REFERENCES &quot;django_content_type&quot; (&quot;id&quot;),
    &quot;revision_id&quot; integer NOT NULL REFERENCES &quot;reversion_revision&quot; (&quot;id&quot;)
);
</pre>
<p>As we can understand, the <tt class="docutils literal">revision</tt> table holds information like who created this
revison (<tt class="docutils literal">user_id</tt>) and when (<tt class="docutils literal">date_created</tt>) while the <tt class="docutils literal">version</tt> stores
a reference to the object that was modified (through a GenericForeignKey) and
the actual data (in the <tt class="docutils literal">serialized_data</tt> field). By default it uses <span class="caps">JSON</span>
to serialize the data (the serialization format is in the <tt class="docutils literal">format</tt> field). There&#8217;s
an one-to-one relation between <tt class="docutils literal">revision</tt> and <tt class="docutils literal">version</tt>.</p>
<p>If we create an instance of <tt class="docutils literal">RBook</tt> we&#8217;ll see the following in the&nbsp;database:</p>
<pre class="code literal-block">
sqlite&gt; select * from reversion_revision;
1|default|2015-01-21 10:31:25.233000||1

sqlite&gt; select * from reversion_version;
1|1|1|json|[{&quot;fields&quot;: {&quot;name&quot;: &quot;asdasdasd&quot;, &quot;author&quot;: &quot;asdasd&quot;}, &quot;model&quot;: &quot;sample.rbook&quot;, &quot;pk&quot;: 1}]|RBook object|12|1
</pre>
<p><tt class="docutils literal">date_created</tt> and <tt class="docutils literal">user_id</tt> are stored on <tt class="docutils literal">revision</tt> while <tt class="docutils literal">format</tt>, <tt class="docutils literal">serialized_data</tt>, <tt class="docutils literal">content_type_id</tt> and
<tt class="docutils literal">object_id_int</tt> (the <tt class="docutils literal">GenericForeignKey</tt>) are stored in <tt class="docutils literal">version</tt>.</p>
</div>
<div class="section" id="id4">
<h3><a class="toc-backref" href="#id20">Usage</a></h3>
<p>To find out information about an object you have to use the <tt class="docutils literal">reversion.get_for_object(object)</tt> method. In order to be
easily used in templates I recommend creating the following <tt class="docutils literal">get_versions()</tt> method in each model that is registered with&nbsp;django-reversion</p>
<pre class="code literal-block">
def get_versions(self):
    return reversion.get_for_object(self)
</pre>
<p>Now, each version has a <tt class="docutils literal">revision</tt> attribute for the corresponding revision and can be used to do the&nbsp;following:</p>
<ul class="simple">
<li>get the user that made the change through the <tt class="docutils literal">revision.user</tt> attribute</li>
<li>get the date of the change through the <tt class="docutils literal">revision.date_created</tt> attribute</li>
<li>get the values of the object fields as they were in this revision using the <tt class="docutils literal">field_dict</tt> attribute</li>
<li>get a model instance as it was on that revision using the <tt class="docutils literal">object_version.object</tt> attribute</li>
<li>revert to that previous version of that object using the <tt class="docutils literal">rever()</tt> method</li>
</ul>
</div>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id21">Conclusion</a></h2>
<p>In the above we say that it is really easy to add basic (<em>who</em> and <em>when</em>) auditing capabilities to your models: You just need to
inherit your models from the <tt class="docutils literal">Auditable</tt> abstract class and inherit your Create and Update CBVs from <tt class="docutils literal">AuditableMixin</tt>.
If you want to know exactly <em>what</em> was changed then you have two solutions: django-simple-history to create an extra table for
each of your models so you&#8217;ll be able to query your historical records (and easily extra aggregates, statistics etc) and
django-reversion to save each version as a json object, so no extra tables will be&nbsp;created.</p>
<p>All three solutions for auditing have been implemented in a sample project at <a class="reference external" href="https://github.com/spapas/auditing-sample">https://github.com/spapas/auditing-sample</a>.</p>
<p>You can clone the project and, preferrably in a virtual environment, install requirements (<tt class="docutils literal">pip install <span class="pre">-r</span> requirements.txt</tt>),
do a migrate (<tt class="docutils literal">python manage.py migrate</tt> &#8212; uses sqlite3 by default) and run the local development
server (<tt class="docutils literal">python manage.py ruinserver</tt>).</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2014/09/15/django-non-html-responses/">Django non-HTML responses</a>
      </h1>
      <p class="meta"><time datetime="2014-09-15T14:20:00" pubdate>Δευ 15 Σεπτέμβριος 2014</time></p>
</header>

  <div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#how-are-cbvs-rendered" id="id2">How are CBVs&nbsp;rendered</a></li>
<li><a class="reference internal" href="#rendering-to-non-html" id="id3">Rendering to non-<span class="caps">HTML</span></a></li>
<li><a class="reference internal" href="#a-non-html-mixin" id="id4">A non-<span class="caps">HTML</span>&nbsp;mixin</a></li>
<li><a class="reference internal" href="#a-more-complex-example" id="id5">A more complex&nbsp;example</a></li>
<li><a class="reference internal" href="#conclusion" id="id6">Conclusion</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>I have already written about the many advantages (<span class="caps">DRY</span>!) of using <a class="reference external" href="http://spapas.github.io/2014/04/11/django-generic-formviews-for-objects/">CBVs in a previous article.</a>
In this article I will present the correct (pythonic) way to allow a normal <span class="caps">CBV</span> to return non-<span class="caps">HTML</span> responses, like <span class="caps">PDF</span>, <span class="caps">CSV</span>, <span class="caps">XSL</span>&nbsp;etc.</p>
</div>
<div class="section" id="how-are-cbvs-rendered">
<h2><a class="toc-backref" href="#id2">How are CBVs&nbsp;rendered</a></h2>
<p>Before proceeding, we need to understand how CBVs are rendered. By walking through the
class hierarchy in the <a class="reference external" href="http://ccbv.co.uk/"><span class="caps">CBV</span> inspector</a>, we can see that
all the normal Django CBVs (DetailView, CreateView, TemplateView etc) are using a mixin
named <a class="reference external" href="http://ccbv.co.uk/projects/Django/1.7/django.views.generic.base/TemplateResponseMixin/">TemplateResponseMixin</a> which defines a method named <tt class="docutils literal">render_to_response</tt>. This
is the method that is used for rendering the output of the Views. Let&#8217;s take a look at
<a class="reference external" href="http://ccbv.co.uk/projects/Django/1.7/django.views.generic.base/TemplateResponseMixin/">how it is defined</a> (I&#8217;ll remove the&nbsp;comments):</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">TemplateResponseMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="n">template_name</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">response_class</span> <span class="o">=</span> <span class="n">TemplateResponse</span>
  <span class="n">content_type</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
      <span class="n">response_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;content_type&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span><span class="p">(</span>
          <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
          <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_template_names</span><span class="p">(),</span>
          <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
          <span class="o">**</span><span class="n">response_kwargs</span>
      <span class="p">)</span>

  <span class="k">def</span> <span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
              <span class="s">&quot;TemplateResponseMixin requires either a definition of &quot;</span>
              <span class="s">&quot;&#39;template_name&#39; or an implementation of &#39;get_template_names()&#39;&quot;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">]</span>
</pre></div>
<p>This method will try to find out which html template should be used to render the View
(using the  <tt class="docutils literal">get_template_names</tt> method and template_name attribute of the mixin) and
then render this view by instantiating an instance of the <tt class="docutils literal">TemplateResponse</tt> class
(as defined in the <tt class="docutils literal">response_class</tt> attribute)
and passing the request, template, context and other response_args to&nbsp;it.</p>
<p>The <a class="reference external" href="https://github.com/django/django/blob/master/django/template/response.py">TemplateResponse</a> class which is instantiated in the <tt class="docutils literal">render_to_response</tt> method
inherits from a normal <tt class="docutils literal">HttpResponse</tt> and is used to render
the template passed to it as a&nbsp;parameter.</p>
</div>
<div class="section" id="rendering-to-non-html">
<h2><a class="toc-backref" href="#id3">Rendering to non-<span class="caps">HTML</span></a></h2>
<p>From the previous discussion we can conclude that if your non-<span class="caps">HTML</span> response <em>needs</em>
a template then you just need to create a subclass of <tt class="docutils literal">TemplateResponse</tt> and
assign it to the <tt class="docutils literal">response_class</tt> attribute (and also change the <tt class="docutils literal">content_type</tt>
attribute). On the other hand, if your non-<span class="caps">HTML</span> respond does not need a template
to be rendered then you have to override <tt class="docutils literal">render_to_response</tt> completely
(since the template parameter does not need to be passed now) and either define
a subclass of HttpResponse or do the rendering in the&nbsp;render_to_response.</p>
<p>Since almost always you won&#8217;t need a template to create a non-<span class="caps">HTML</span> view and because
I believe that the solution is <span class="caps">DRY</span>-enough by implementing the rendering code to
the <tt class="docutils literal">render_to_response</tt> method (<em>without</em> subclassing <tt class="docutils literal">HttpResponse</tt>) I will
implement a mixin that does exactly&nbsp;that.</p>
<p>Subclassing <tt class="docutils literal">HttpResponse</tt> will not make our design more <span class="caps">DRY</span> because for every
subclass of <tt class="docutils literal">HttpResponse</tt> the <tt class="docutils literal">render_to_response</tt> method would also need to
be modified (by subclassing <tt class="docutils literal">TemplateResponseMixin) to instantiate the subclass of ``HttpResponse</tt> with the correct parameters.
For instance, the existing <tt class="docutils literal">TemplateResponseMixin</tt> cannot be used if the subclass
of <tt class="docutils literal">HttpResponse</tt> does not take a template as a parameter (solutions like
passing None to the template parameter are signals of bad&nbsp;design).</p>
<p>In any case, changing just the <tt class="docutils literal">render_to_response</tt> method using a Mixin is in my opinion the best solution
to the above problem.
A <a class="reference external" href="http://stackoverflow.com/questions/533631/what-is-a-mixin-and-why-are-they-useful">Mixin</a> is a simple class that can be used to extend other classes either by overriding functionality of the base class or
by adding extra features. Django CBVs use various <a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/class-based-views/mixins/">mixins</a> to extend the base Views and add&nbsp;functionality.</p>
</div>
<div class="section" id="a-non-html-mixin">
<h2><a class="toc-backref" href="#id4">A non-<span class="caps">HTML</span>&nbsp;mixin</a></h2>
<p>So, a basic skeleton for our mixin would be something like&nbsp;this:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">NonHtmlResponseMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&quot;Hello, world&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>The previous mixin overrides the render_to_response method to just return the text &quot;Hello, world&quot;. For instance
we could define the following&nbsp;class:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">DummyTextResponseView</span><span class="p">(</span><span class="n">NonHtmlResponseMixin</span><span class="p">,</span> <span class="n">TemplateView</span><span class="p">,):</span>
  <span class="k">pass</span>
</pre></div>
<p>which can be added as a route to <tt class="docutils literal">urls.py</tt> (using the <tt class="docutils literal">as_view</tt> method) and will always return the &quot;Hello, world&quot;&nbsp;text.</p>
<p>Here&#8217;s something more complicated: A Mixin that can be used along with a DetailView and will output the properties of the
object as&nbsp;text:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">TextPropertiesResponseMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s">&#39;text/plain; charset=utf-8&#39;</span><span class="p">)</span>
      <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
      <span class="n">o</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span>
      <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
          <span class="n">response</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">u&#39;{0}: {1}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="nb">unicode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
      <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>and can be used like&nbsp;this</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">TextPropertiesDetailView</span><span class="p">(</span><span class="n">TextPropertiesResponseMixin</span><span class="p">,</span> <span class="n">FooDetailView</span><span class="p">,):</span>
  <span class="k">pass</span>
</pre></div>
<p>The above mixin will use the get_object() method of the DetailView to get the object and then output
it as text. We can create similar mixins that will integrate with other types of CBVs, for instance
to export a ListView as an <span class="caps">CSV</span> or generate an png from a DetailView of an Image&nbsp;file.</p>
</div>
<div class="section" id="a-more-complex-example">
<h2><a class="toc-backref" href="#id5">A more complex&nbsp;example</a></h2>
<p>The previous examples all built upon an existing view (either a TemplateView, a DetailView or a ListView).
However, an existing view that will fit our requirements won&#8217;t always be available. For instance,
sometimes I want to export data from my database using a raw <span class="caps">SQL</span> query. Also I&#8217;d like to be able to easily
export this data as csv or&nbsp;excel.</p>
<p>First of all, we need to define a view that will inherit from <tt class="docutils literal">View</tt> and export the data as a <span class="caps">CSV</span>:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">unicodecsv</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">View</span>

<span class="k">class</span> <span class="nc">CsvRawSqlExportView</span><span class="p">(</span><span class="n">View</span><span class="p">,</span> <span class="p">):</span>
  <span class="n">sql</span> <span class="o">=</span> <span class="s">&#39;select 1+1&#39;</span>
  <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;res&#39;</span><span class="p">]</span>
  <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">generate_data</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
              <span class="k">yield</span> <span class="n">row</span>

      <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
      <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
      <span class="n">generator</span> <span class="o">=</span> <span class="n">generate_data</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s">&#39;text/plain; charset=utf-8&#39;</span><span class="p">)</span>
      <span class="n">response</span><span class="p">[</span><span class="s">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;attachment; filename=export.csv&#39;</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">unicodecsv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="n">w</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">:</span>
          <span class="n">w</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>The above View has three attributes:
* sql, which is a string with the raw sql that will be executed
* headers, which is an array with the names of each header of the resulting data
* params, which is an array with parameters that may need to be passed to the&nbsp;query</p>
<p>The <tt class="docutils literal">get</tt> method executes the query and passes the result to <tt class="docutils literal">render_to_response</tt>
using a generator.  The <tt class="docutils literal">render_to_response</tt> method instantiates an HttpResponse
object with the correct attributes and writes the <span class="caps">CSV</span> to the response object using&nbsp;unicodecsv.</p>
<p>We can now quickly create a route that will export data from the users&nbsp;table:</p>
<div class="highlight"><pre><span class="n">url</span><span class="p">(</span>
    <span class="s">r&#39;^raw_export_users/$&#39;</span><span class="p">,</span>
    <span class="n">views</span><span class="o">.</span><span class="n">CsvRawSqlExportView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
        <span class="n">sql</span><span class="o">=</span><span class="s">&#39;select id, username from auth_user&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&#39;raw_export_users&#39;</span>
<span class="p">),</span>
</pre></div>
<p>If instead of <span class="caps">CSV</span> we wanted to export to <span class="caps">XLS</span> (using xlwt), we&#8217;d just need to create a&nbsp;Mixin:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">XlsRawSqlResponseMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/ms-excel&#39;</span><span class="p">)</span>
      <span class="n">response</span><span class="p">[</span><span class="s">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;attachment; filename=export.xls&#39;</span>
      <span class="n">wb</span> <span class="o">=</span> <span class="n">xlwt</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">):</span>
              <span class="n">ws</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">generator</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
              <span class="n">ws</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>

      <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>and create a View that inherits from <tt class="docutils literal">CsvRawSqlExportView</tt> and uses the above&nbsp;mixin:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">XlsRawSqlExportView</span><span class="p">(</span> <span class="n">XlsRawSqlResponseMixin</span><span class="p">,</span> <span class="n">CsvRawSqlExportView</span> <span class="p">):</span>
  <span class="k">pass</span>
</pre></div>
<p>and route to that view to get the <span class="caps">XLS</span>:</p>
<div class="highlight"><pre><span class="n">url</span><span class="p">(</span>
    <span class="s">r&#39;^raw_export_users/$&#39;</span><span class="p">,</span>
    <span class="n">views</span><span class="o">.</span><span class="n">XlsRawSqlExportView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
        <span class="n">sql</span><span class="o">=</span><span class="s">&#39;select id, username from auth_user&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">]),</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&#39;raw_export_users&#39;</span>
<span class="p">),</span>
</pre></div>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id6">Conclusion</a></h2>
<p>Using the above techniques we can define CBVs that will output their content in various content types
beyond <span class="caps">HTML</span>. This will help us write write clean and <span class="caps">DRY</span>&nbsp;code.</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2014/04/11/django-generic-formviews-for-objects/">Django generic FormViews for objects</a>
      </h1>
      <p class="meta"><time datetime="2014-04-11T10:23:00" pubdate>Παρ 11 Απρίλιος 2014</time></p>
</header>

  <div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#a-quick-introduction-to-the-formview" id="id2">A quick introduction to the <tt class="docutils literal">FormView</tt></a></li>
<li><a class="reference internal" href="#a-quick-introduction-to-the-singleobjectmixin" id="id3">A quick introduction to the <tt class="docutils literal">SingleObjectMixin</tt></a></li>
<li><a class="reference internal" href="#being-generic-and-dry" id="id4">Being generic and <span class="caps">DRY</span></a></li>
<li><a class="reference internal" href="#being-more-generic-and-dry" id="id5">Being more generic and <span class="caps">DRY</span></a></li>
<li><a class="reference internal" href="#other-options" id="id6">Other&nbsp;options</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>We recently needed to create a number of views for changing the status of an Application model instance for our organization.
An Application model instance can be filled and then cancelled, submitted, acceptted etc - for each of these status changes a form should be
presented to the user. When the user submits the form the status of the Application will be&nbsp;changed.</p>
<p>To implement the above requirement we created a generic FormView that acts on the specific model instance. This
used two basic <span class="caps">CBV</span> components: The <tt class="docutils literal">FormView</tt> for the form manipulation and the <tt class="docutils literal">SingleObjectMixing</tt> for the
object&nbsp;handling.</p>
<p>Django <a class="reference external" href="https://docs.djangoproject.com/en/1.6/topics/class-based-views/">Class Based Views</a> (CBVs) can be used to create reusable Views using normal class inheritance. Most
people use the well-known <tt class="docutils literal">CreateView</tt>, <tt class="docutils literal">UpdateView</tt>, <tt class="docutils literal">DetailView</tt> and <tt class="docutils literal">ListView</tt>, however, as we
will see below, the <tt class="docutils literal">FormView</tt> will help us write <span class="caps">DRY</span>&nbsp;code.</p>
<p>I have to notice here that an invaluable tool to help you understanding CBVs is the <a class="reference external" href="http://ccbv.co.uk/"><span class="caps">CBV</span> inspector</a> which
has a nice web interface for browsing the <span class="caps">CBV</span> hierarchies, attributes and&nbsp;methods.</p>
</div>
<div class="section" id="a-quick-introduction-to-the-formview">
<h2><a class="toc-backref" href="#id2">A quick introduction to the <tt class="docutils literal">FormView</tt></a></h2>
<p>A simple <tt class="docutils literal">FormView</tt> can be defined like this (<a class="reference external" href="http://ccbv.co.uk/projects/Django/1.6/django.views.generic.edit/FormView/"><span class="caps">CBV</span> FormView</a>):</p>
<pre class="code literal-block">
class MyFormView(FormView):
  form_class = forms.MyFormView
  template_name = 'my_template.html'
</pre>
<p>The above can be used in urls.py like&nbsp;this:</p>
<pre class="code literal-block">
urlpatterns = patterns('',
  url(r'^my_formview/$', views.MyFormView.as_view() , name='my_formview' ),
</pre>
<p>This will present a form to the user when he visits the <tt class="docutils literal">my_formview</tt>  url &#8212; however this form won&#8217;t do anything. To allow
the form to actually do something when it&#8217;s been submitted we need to override the <tt class="docutils literal">form_valid</tt> method.</p>
<pre class="code literal-block">
def form_valid(self, form):
    value = form.cleaned_data['value']
    messages.info(self.request, &quot;MyForm submitted with value {0}!&quot;.format(value) )
    return HttpResponseRedirect( reverse('my_formview') )
</pre>
<p>As you can see the submitted form is passed in the method and can be used to receive its <tt class="docutils literal">cleaned_data</tt>. The <tt class="docutils literal">FormView</tt>
has various other options for instance a <tt class="docutils literal">form_invalid</tt> method, an <tt class="docutils literal">initial</tt> attribute to set the initial values for the form&nbsp;etc.</p>
</div>
<div class="section" id="a-quick-introduction-to-the-singleobjectmixin">
<h2><a class="toc-backref" href="#id3">A quick introduction to the <tt class="docutils literal">SingleObjectMixin</tt></a></h2>
<p>A <tt class="docutils literal">SingleObjectMixin</tt> adds a number of attributes <span class="amp">&amp;</span> methods to a view that can be used for object manipulation. The
most important ones is the <tt class="docutils literal">model</tt> and <tt class="docutils literal">queryset</tt> attributes and the <tt class="docutils literal">get_queryset</tt> and <tt class="docutils literal">get_object()</tt>. To use
the <tt class="docutils literal">SingleObjectMixin</tt> in your <span class="caps">CBV</span> just add it to the list of the classes to inherit from and define either the
<tt class="docutils literal">model</tt> or the <tt class="docutils literal">queryset</tt> attribute. After that you may pass a <tt class="docutils literal">pk</tt> parameter to your view and you will get an
<tt class="docutils literal">object</tt> context variable in the template with the selected&nbsp;object!</p>
</div>
<div class="section" id="being-generic-and-dry">
<h2><a class="toc-backref" href="#id4">Being generic and <span class="caps">DRY</span></a></h2>
<p>We can more or less now understand how we should use <tt class="docutils literal">FormView</tt> and <tt class="docutils literal">SingleObjectMixin</tt> to generate our
generic <tt class="docutils literal">FormView</tt> for acting on objects: Our <tt class="docutils literal">FormView</tt> should <em>get</em> the object using the <tt class="docutils literal">SingleObjectMixin</tt>
and change it when the form is submitted using the values from the form. A first implementation would be the&nbsp;following:</p>
<pre class="code literal-block">
class GenericObjectFormView1(FormView, SingleObjectMixin):

    def form_valid(self, form):
        obj = self.get_object()
        obj.change_status(form)
        return HttpResponseRedirect( obj.get_absolute_url() )
</pre>
<p>So our <tt class="docutils literal">GenericObjectFormView1</tt> class inherits from <tt class="docutils literal">FormView</tt> and <tt class="docutils literal">SingleObjectMixin</tt>. The only thing that we have
to assure is that the Model we want to act on needs to implement a <tt class="docutils literal">change_status</tt> method which gets the <tt class="docutils literal">form</tt> and
changes the status of that object based on its value. For instance, two implementations can be the&nbsp;following:</p>
<pre class="code literal-block">
class CancelObjectFormView(GenericObjectFormView1):
    template_name = 'cancel.html'
    form_class = forms.CancelForm
    model = models.Application

class SubmitObjectFormView(GenericObjectFormView1):
    template_name = 'submit.html'
    form_class = forms.SubmitForm
    model = models.Application
</pre>
</div>
<div class="section" id="being-more-generic-and-dry">
<h2><a class="toc-backref" href="#id5">Being more generic and <span class="caps">DRY</span></a></h2>
<p>The previous implementation has two&nbsp;problems:</p>
<ul class="simple">
<li>What happens if the status of the object should not be changed even if the form <em>is</em>&nbsp;valid?</li>
<li>We shouldn&#8217;t need to create a new template for every new <tt class="docutils literal">GenericObjectFormView</tt> since all these templates will just output the object information, ask a question for the status change and output the&nbsp;form.</li>
</ul>
<p>Let&#8217;s write a new version of our GenericObjectFormView that actually resolves&nbsp;these:</p>
<pre class="code literal-block">
class GenericObjectFormView2(FormView, SingleObjectMixin):
    template_name = 'generic_formview.html'
    ok_message = ''
    not_ok_message = ''
    title = ''
    question =''

    def form_valid(self, form):
        obj = self.get_object()
        r = obj.change_status(form)
        if r:
            messages.info(self.request, self.yes_message)
        else:
            messages.info(self.request, self.not_ok_message)
        return HttpResponseRedirect( obj.get_absolute_url() )

    def get_context_data(self, **kwargs):
        context = super(GenericYesNoFormView, self).get_context_data(**kwargs)
        context['title'] = self.title
        context['question'] = self.question
        return context
</pre>
<p>The above adds an ok and not ok message which will be outputed if the status can or cannot be changed. To accomplish this,
the <tt class="docutils literal">change_status</tt> method should now return a boolean value to mark if the action was ok or not. Also, a generic template
will now be used. This template has two placeholders: One for the title of the page (<tt class="docutils literal">title</tt> attribute) and one for the
question asked to the user (<tt class="docutils literal">question</tt> attribute). Now we can use it like&nbsp;this:</p>
<pre class="code literal-block">
class CancelObjectFormView(GenericObjectFormView2):
    form_class = forms.CancelForm
    model = models.Application
    ok_message = 'Cancel success!'
    not_ok_message = 'Not able to cancel!'
    title = 'Cancel an object'
    question = 'Do you want to cancel this object?'

class SubmitObjectFormView(GenericObjectFormView2):
    form_class = forms.SubmitForm
    model = models.Application
    ok_message = 'Submit  ok'
    not_ok_message = 'Cannot submit!'
    title = 'Submit an object'
    question ='Do you want to submit this object?'
</pre>
</div>
<div class="section" id="other-options">
<h2><a class="toc-backref" href="#id6">Other&nbsp;options</a></h2>
<p>We&#8217;ve just got a glimpse of how we can use CBVs to increase the DRYness of our Django applications. There are various
extra things that we can add to our <tt class="docutils literal">GenericObjectFormView2</tt> as attributes which will be defined by inheriting
classes. Some ideas is to check if the current user actually has access to modify the object (hint: override the
<tt class="docutils literal">get_object</tt> method of <tt class="docutils literal">SingleObjectMixin</tt>) or render the form diffirently depending on the current user (hint:
override the <tt class="docutils literal">get_form_kwargs</tt> method of <tt class="docutils literal">FormView</tt>).</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2014/02/13/wagtail-tutorial/">A Wagtail tutorial</a>
      </h1>
      <p class="meta"><time datetime="2014-02-13T21:20:00" pubdate>Πεμ 13 Φεβρουάριος 2014</time></p>
</header>

  <div class="entry-content"><p><a href="http://wagtail.io">Wagtail</a> is a new Open Source <a href="https://www.djangoproject.com">Django</a>-based <span class="caps">CMS</span>. In this 20 minute tutorial we will see how you can create a blog from scratch using Wagtail. If you want to see some more examples of usage please take a look at the <a href="https://github.com/torchbox/wagtaildemo">wagtaildemo</a> GitHub&nbsp;project.</p>
<p>To follow this tutorial you will need to have <a href="http://python.org/">Python</a> 2.7 installed with a working version of <a href="https://pypi.python.org/pypi/pip">pip</a> and <a href="https://pypi.python.org/pypi/virtualenv">virtualenv</a>.</p>
<p><strong>Update</strong>: The result of this tutorial has been deployed to <a href="https://www.heroku.com/">Heroku</a>: <a href="http://gentle-refuge-2590.herokuapp.com/">http://gentle-refuge-2590.herokuapp.com/</a> - you may visit the <a href="http://gentle-refuge-2590.herokuapp.com/admin/">admin site</a> and login with root / 123 to play with Wagtail! Please don&#8217;t do anything naughty !!! Also, notice that <a href="https://devcenter.heroku.com/articles/dynos#isolation-and-security">because of how Heroku works</a> you won&#8217;t be able to upload&nbsp;anything.</p>
<h2>Installing the wagtail&nbsp;dependencies</h2>
<p>It is recomended to create a new virtual environment that will host the wagtail tutorial. After you have changed to the virtual environment you will need to installl the Wagtail requirements. Create a file named <code>requirements.txt</code> containing the&nbsp;following:</p>
<div class="highlight"><pre><span class="n">Django</span><span class="o">==</span><span class="mf">1.6.2</span>
<span class="n">South</span><span class="o">==</span><span class="mf">1.0.0</span>
<span class="n">django</span><span class="o">-</span><span class="n">compressor</span><span class="o">==</span><span class="mf">1.4</span>
<span class="n">django</span><span class="o">-</span><span class="n">modelcluster</span><span class="o">==</span><span class="mf">0.3</span>
<span class="o">-</span><span class="n">e</span> <span class="n">git</span><span class="o">:</span><span class="c1">//github.com/torchbox/wagtail.git#egg=wagtail</span>
<span class="n">django</span><span class="o">-</span><span class="n">taggit</span><span class="o">==</span><span class="mf">0.11.2</span>
<span class="n">django</span><span class="o">-</span><span class="n">libsass</span><span class="o">==</span><span class="mf">0.2</span>
</pre></div>


<p>and run
<code>pip install -r requirements.txt</code>.  If you use Microsoft Windows you <em>will</em> experience problems with Pillow and lxml. Please download the 
installation executables from https://pypi.python.org/pypi/Pillow/2.3.0 and https://pypi.python.org/pypi/lxml/3.3.1, install 
them using <code>easy_install Pillow-2.3.0.x-py2.7.exe</code> and <code>easy_install lxml-3.3.1.x-py2.7.exe</code> (from inside your virtual environment) 
and then install the other requirements. Also please use the latest version of Wagtail (hosted on github) because it has some changes from 
the pypi (so <em>don&#8217;t</em> do a <code>pip install wagtail</code>).</p>
<p><strong>Warning:</strong> Unfortuanately, no official binaries for libsass (which is a django-libsass requirement) are (yet) available for Windows. I
have compiled a version for win32 and python 2.7 (which I use) using the <a href="http://www.confusedbycode.com/articles/compiling-python-modules.html">instructions found here</a>. You can download this version 
<a href="http://spapas.github.io/images/libsass-0.3.0-cp27-none-win32.whl">as a wheel package</a>. Notice that because libsass was compiled with <span class="caps">VC</span> Express 2013
you should also install the <a href="http://www.microsoft.com/en-us/download/details.aspx?id=40784">Visual C++ 2013 redistributable</a> package from&nbsp;Microsoft.</p>
<p><em>Please use it at your own risk&nbsp;!!!</em></p>
<p>To install <a href="http://pythonwheels.com/">wheels</a> you have to use a version of pip &gt;= 1.4 (so do an <code>easy_install -U pip</code> from your
virtual environment if you have a previous version) and then you can just do a normal <code>pip install libsass-0.3.0-cp27-none-win32.whl</code>. </p>
<p><strong>Warning no2:</strong> More unfortuanately, there seem to be <a href="https://github.com/torchbox/wagtail/issues/133">a number of issues</a> with how libsass handles <code>@import</code> statements
in Windows. Until this is fixed, Windows users are recommened to use the command line (Ruby) sass compiler. To use it, please
install Ruby in your system and then install sass with <code>gem install sass -v "&gt;=3.3.0alpha" --pre</code>. After that, in the <code>COMPRESS_PRECOMPILERS</code> 
setting of your <code>settings.py</code> (discussed in the next section), change the line <code>('text/x-scss', 'django_libsass.SassCompiler'),</code> to 
<code>('text/x-scss', 'sass --scss  {infile} {outfile}'),</code>.</p>
<h2>Creating and configuring your&nbsp;project</h2>
<p>Wagtail has to &#8220;live&#8221; inside a normal Django project so you now may create a new Django project by&nbsp;issuing:</p>
<div class="highlight"><pre>python &lt;PATH_OF_YOUR_VIRTUAL_ENV&gt;/scripts/django-admin.py startproject wagtailtutorial
</pre></div>


<p>If you use Unix you can just run <code>django-admin.py</code> etc however if you try to do the same in windows you
will find out that windows tries to run the .py file with the python executable that is assigned through
explorer (which of course is your main python installation) and <em>not</em> through your path! That&#8217;s why
all our commands will be in the form <code>python script.py</code> to make sure that Windows picks the python
executable from your path (which, if you&#8217;re inside the virtual enviroment will be the correct&nbsp;one).</p>
<p>Inside the <code>wagtailtutorial</code> folder you will see a file named <code>manage.py</code> and another folder named <code>wagtailtutorial</code>. Inside this <code>wagtailtutorial</code> folder you will find <code>settings.py</code> and <code>urls.py</code> which need to be&nbsp;changed.</p>
<p>Starting with <code>urls.py</code>, remove everything and change it like&nbsp;this:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.conf.urls.static</span> <span class="kn">import</span> <span class="n">static</span>
<span class="kn">from</span> <span class="nn">django.views.generic.base</span> <span class="kn">import</span> <span class="n">RedirectView</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">import</span> <span class="nn">os.path</span>

<span class="kn">from</span> <span class="nn">wagtail.wagtailcore</span> <span class="kn">import</span> <span class="n">urls</span> <span class="k">as</span> <span class="n">wagtail_urls</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailadmin</span> <span class="kn">import</span> <span class="n">urls</span> <span class="k">as</span> <span class="n">wagtailadmin_urls</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailimages</span> <span class="kn">import</span> <span class="n">urls</span> <span class="k">as</span> <span class="n">wagtailimages_urls</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailembeds</span> <span class="kn">import</span> <span class="n">urls</span> <span class="k">as</span> <span class="n">wagtailembeds_urls</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtaildocs</span> <span class="kn">import</span> <span class="n">admin_urls</span> <span class="k">as</span> <span class="n">wagtaildocs_admin_urls</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtaildocs</span> <span class="kn">import</span> <span class="n">urls</span> <span class="k">as</span> <span class="n">wagtaildocs_urls</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailsnippets</span> <span class="kn">import</span> <span class="n">urls</span> <span class="k">as</span> <span class="n">wagtailsnippets_urls</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailsearch.urls</span> <span class="kn">import</span> <span class="n">frontend</span> <span class="k">as</span> <span class="n">wagtailsearch_frontend_urls</span><span class="p">,</span> <span class="n">admin</span> <span class="k">as</span> <span class="n">wagtailsearch_admin_urls</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailusers</span> <span class="kn">import</span> <span class="n">urls</span> <span class="k">as</span> <span class="n">wagtailusers_urls</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailredirects</span> <span class="kn">import</span> <span class="n">urls</span> <span class="k">as</span> <span class="n">wagtailredirects_urls</span>

<span class="n">admin</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">()</span>


<span class="c"># Signal handlers</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailsearch</span> <span class="kn">import</span> <span class="n">register_signal_handlers</span> <span class="k">as</span> <span class="n">wagtailsearch_register_signal_handlers</span>
<span class="n">wagtailsearch_register_signal_handlers</span><span class="p">()</span>


<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^django-admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>

    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/images/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">wagtailimages_urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/embeds/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">wagtailembeds_urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/documents/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">wagtaildocs_admin_urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/snippets/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">wagtailsnippets_urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/search/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">wagtailsearch_admin_urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/users/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">wagtailusers_urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/redirects/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">wagtailredirects_urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">wagtailadmin_urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^search/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">wagtailsearch_frontend_urls</span><span class="p">)),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^documents/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">wagtaildocs_urls</span><span class="p">)),</span>

    <span class="c"># For anything not caught by a more specific rule above, hand over to</span>
    <span class="c"># Wagtail&#39;s serving mechanism</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">wagtail_urls</span><span class="p">)),</span>
<span class="p">)</span>


<span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.contrib.staticfiles.urls</span> <span class="kn">import</span> <span class="n">staticfiles_urlpatterns</span>

    <span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">staticfiles_urlpatterns</span><span class="p">()</span> <span class="c"># tell gunicorn where static files are in dev mode</span>
    <span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">static</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span> <span class="o">+</span> <span class="s">&#39;images/&#39;</span><span class="p">,</span> <span class="n">document_root</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">,</span> <span class="s">&#39;images&#39;</span><span class="p">))</span>
</pre></div>


<p>You can se that there is a signal handler when a searchable thing is added or changed to handle indexing for search, normal django admin is mapped under /django-admin since /admin is use for Wagtail (of course you may map Wagtail wherever you&#8217;d like), inclusion of various wagtail related urls and finally a Wagtail handling everything else. Finally there are some handlers for media and static&nbsp;files.</p>
<p>After that please change your <code>settings.py</code> like&nbsp;this:</p>
<div class="highlight"><pre><span class="c"># Django settings for wagtailtutorial project.</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="n">PROJECT_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&#39;..&#39;</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">)</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">TEMPLATE_DEBUG</span> <span class="o">=</span> <span class="n">DEBUG</span>

<span class="n">ADMINS</span> <span class="o">=</span> <span class="p">()</span>
<span class="n">MANAGERS</span> <span class="o">=</span> <span class="n">ADMINS</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s">&#39;django.db.backends.sqlite3&#39;</span><span class="p">,</span>
        <span class="s">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">PROJECT_ROOT</span><span class="o">+</span><span class="s">&#39;/wagtailtutorial.db&#39;</span><span class="p">,</span>
        <span class="s">&#39;USER&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
        <span class="s">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
        <span class="s">&#39;HOST&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>  <span class="c"># Set to empty string for localhost.</span>
        <span class="s">&#39;PORT&#39;</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span>  <span class="c"># Set to empty string for default.</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="n">CONN_MAX_AGE</span> <span class="o">=</span> <span class="mi">600</span>  <span class="c"># number of seconds database connections should persist for</span>
<span class="n">ALLOWED_HOSTS</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s">&#39;Europe/London&#39;</span>
<span class="n">LANGUAGE_CODE</span> <span class="o">=</span> <span class="s">&#39;en-gb&#39;</span>
<span class="n">SITE_ID</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">USE_I18N</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">USE_L10N</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">USE_TZ</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">MEDIA_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="s">&#39;media&#39;</span><span class="p">)</span>
<span class="n">MEDIA_URL</span> <span class="o">=</span> <span class="s">&#39;/media/&#39;</span>
<span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">PROJECT_ROOT</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
<span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s">&#39;/static/&#39;</span>
<span class="n">STATICFILES_DIRS</span> <span class="o">=</span> <span class="p">()</span>

<span class="n">STATICFILES_FINDERS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.contrib.staticfiles.finders.FileSystemFinder&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.staticfiles.finders.AppDirectoriesFinder&#39;</span><span class="p">,</span>
    <span class="s">&#39;compressor.finders.CompressorFinder&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s">&#39;wq21wtjo3@d_qfjvd-#td!</span><span class="si">%7g</span><span class="s">fy2updj2z+nev^k$iy%=m4_tr&#39;</span>

<span class="n">TEMPLATE_LOADERS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.template.loaders.filesystem.Loader&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.template.loaders.app_directories.Loader&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;wagtail.wagtailcore.middleware.SiteMiddleware&#39;</span><span class="p">,</span>
    <span class="s">&#39;wagtail.wagtailredirects.middleware.RedirectMiddleware&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">global_settings</span>
<span class="n">TEMPLATE_CONTEXT_PROCESSORS</span> <span class="o">=</span> <span class="n">global_settings</span><span class="o">.</span><span class="n">TEMPLATE_CONTEXT_PROCESSORS</span> <span class="o">+</span> <span class="p">(</span>
    <span class="s">&#39;django.core.context_processors.request&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ROOT_URLCONF</span> <span class="o">=</span> <span class="s">&#39;wagtailtutorial.urls&#39;</span>
<span class="n">WSGI_APPLICATION</span> <span class="o">=</span> <span class="s">&#39;wagtailtutorial.wsgi.application&#39;</span>
<span class="n">TEMPLATE_DIRS</span> <span class="o">=</span> <span class="p">()</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="c"># &#39;django.contrib.sites&#39;,  # Wagtail uses its own site management logic</span>
    <span class="s">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>

    <span class="s">&#39;south&#39;</span><span class="p">,</span>
    <span class="s">&#39;compressor&#39;</span><span class="p">,</span>
    <span class="s">&#39;taggit&#39;</span><span class="p">,</span>
    <span class="s">&#39;modelcluster&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.admin&#39;</span><span class="p">,</span>

    <span class="s">&#39;wagtail.wagtailcore&#39;</span><span class="p">,</span>
    <span class="s">&#39;wagtail.wagtailadmin&#39;</span><span class="p">,</span>
    <span class="s">&#39;wagtail.wagtaildocs&#39;</span><span class="p">,</span>
    <span class="s">&#39;wagtail.wagtailsnippets&#39;</span><span class="p">,</span>
    <span class="s">&#39;wagtail.wagtailusers&#39;</span><span class="p">,</span>
    <span class="s">&#39;wagtail.wagtailimages&#39;</span><span class="p">,</span>
    <span class="s">&#39;wagtail.wagtailembeds&#39;</span><span class="p">,</span>
    <span class="s">&#39;wagtail.wagtailsearch&#39;</span><span class="p">,</span>
    <span class="s">&#39;wagtail.wagtailredirects&#39;</span><span class="p">,</span>

    <span class="s">&#39;tutorial&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">EMAIL_SUBJECT_PREFIX</span> <span class="o">=</span> <span class="s">&#39;[wagtailtutorial] &#39;</span>

<span class="n">INTERNAL_IPS</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="s">&#39;10.0.2.2&#39;</span><span class="p">)</span>

<span class="n">COMPRESS_PRECOMPILERS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s">&#39;text/x-scss&#39;</span><span class="p">,</span> <span class="s">&#39;django_libsass.SassCompiler&#39;</span><span class="p">),</span>
<span class="p">)</span>

<span class="c"># Auth settings</span>
<span class="n">LOGIN_URL</span> <span class="o">=</span> <span class="s">&#39;django.contrib.auth.views.login&#39;</span>
<span class="n">LOGIN_REDIRECT_URL</span> <span class="o">=</span> <span class="s">&#39;wagtailadmin_home&#39;</span>

<span class="n">LOGGING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">&#39;disable_existing_loggers&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
    <span class="s">&#39;filters&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;require_debug_false&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;()&#39;</span><span class="p">:</span> <span class="s">&#39;django.utils.log.RequireDebugFalse&#39;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;mail_admins&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;ERROR&#39;</span><span class="p">,</span>
            <span class="s">&#39;filters&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;require_debug_false&#39;</span><span class="p">],</span>
            <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;django.utils.log.AdminEmailHandler&#39;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s">&#39;loggers&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&#39;django.request&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;mail_admins&#39;</span><span class="p">],</span>
            <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;ERROR&#39;</span><span class="p">,</span>
            <span class="s">&#39;propagate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c"># WAGTAIL SETTINGS</span>
<span class="n">WAGTAIL_SITE_NAME</span> <span class="o">=</span> <span class="s">&#39;wagtailtutorial&#39;</span>

<span class="c"># Override the search results template for wagtailsearch</span>
<span class="n">WAGTAILSEARCH_RESULTS_TEMPLATE</span> <span class="o">=</span> <span class="s">&#39;tutorial/search_results.html&#39;</span>
<span class="n">WAGTAILSEARCH_RESULTS_TEMPLATE_AJAX</span> <span class="o">=</span> <span class="s">&#39;tutorial/includes/search_listing.html&#39;</span>

<span class="n">WAGTAILSEARCH_ES_INDEX</span> <span class="o">=</span> <span class="s">&#39;wagtailtutorial&#39;</span>
</pre></div>


<p>The most important thing to notice is that  the <code>INSTALLED_APPS</code> contains the usual apps from django.*, <a href="http://south.aeracode.org/">south</a> for database migrations, <a href="https://github.com/django-compressor/django-compressor">django-compressor</a> to support compressing static files (and automatic translating from less to css), <a href="https://github.com/alex/django-taggit">django-taggit</a> to add support for tags, and <a href="https://github.com/torchbox/django-modelcluster/">django-modelcluster</a> which adds support from clusters (groups) of models. It also contains the wagtail.* applications and the tutorial application which is where we will create our blog. Also there are two Wagtail related middleware (one to add a site attribute to each request and one to hand redirects), configuring django-compressor to use <code>django_libsass</code> to compile <code>less</code> files, and some other, not so important Wagtail&nbsp;settings.</p>
<p>So let&#8217;s create the missing tutorial application by&nbsp;issuing:</p>
<div class="highlight"><pre>python manage.py startapp tutorial
</pre></div>


<p>Now we&#8217;ll have a <code>tutorial</code> folder waiting to define our blog structure inside the <code>wagtailtutorial</code> folder!</p>
<h2>Checking to see if everything&nbsp;works</h2>
<p>Before continuing with our blog creation let&#8217;s make sure that everything works, first of all by generating the database&nbsp;schema:</p>
<div class="highlight"><pre>python manage.py syncdb
</pre></div>


<p>In the superuser question answer yes and add a superuser. Then you can run the migrations - however because there are some problems with the way SQLite3 runs migrations it is recommended to run the migrations in two&nbsp;steps:</p>
<div class="highlight"><pre>python manage.py migrate 0001 --all
python manage.py migrate
</pre></div>


<p>Finally, you now may try&nbsp;a</p>
<div class="highlight"><pre>python manage.py runserver
</pre></div>


<p>and visit <code>http://127.0.0.1:8000</code>. If everything worked fine you will get&nbsp;a</p>
<blockquote>
<p>Welcome to your new Wagtail&nbsp;site!</p>
</blockquote>
<p>page &#8212; congratulations&nbsp;!</p>
<p>The homepage is rather simple (for now!) but you may already navigate to http://127.0.0.1:8000/admin and from there, login to Wagtail admin with the superuser you created earlier. 
Now you may start experiencing Wagtail&nbsp;! </p>
<p><img alt="Wagtail admin index" src="http://spapas.github.io/images/wagtail-index.png" /></p>
<h2>Exploring Wagtail&nbsp;admin</h2>
<p>When you login to Wagtail admin you will see a menu at the left with the&nbsp;options:</p>
<ul>
<li>Explorer is used to actually manage the content of your&nbsp;site</li>
<li>Search is used for searching through your&nbsp;content</li>
<li>Images is used to manage your&nbsp;images</li>
<li>Documents is used to manage your&nbsp;Documents</li>
<li>Snippets is used for side bars&nbsp;etc</li>
<li>Users is used for User&nbsp;management</li>
<li>Redirects is used to redirect to a specific&nbsp;page</li>
<li>Editors picks is used to promote search&nbsp;results</li>
</ul>
<p>Of the previous, the one needing more explanation is Explorer: Clicking it you will see that a label named &#8220;Welcome to your Wagtail site!&#8221; will open. This is the root Page of your site. If you click at it you will go to the actions of this page. The actions you can do here is:
 - Add Child Page
 - Edit
 - View Live
 - Move
 - Delete
 -&nbsp;Unpublish</p>
<p>The Pages (and more generally the Content) of Wagtail are Django Models that are saved through a Tree hierarchy. However, if you click &#8220;Add Child Page&#8221; you won&#8217;t be able to add anything because you must create your own Page types (we will see how it is done in the next&nbsp;section). </p>
<p>When you click edit you will be able to edit the parts of the page (each part is a normal Field of the model). Also, you will see that the form is split into two tabs: Content and Promote. In the Content for instance you will see that the &#8220;Welcome to your Wagtail site!&#8221; has only a &#8220;Title&#8221; CharField. These are the fields that will be available to all Pages since &#8220;Welcome to your Wagtail site!&#8221; has a class of <code>Page</code> from which every other page should inherit. After you finish editing a page you may save it as a draft, publish, sent it for moderation (if you don&#8217;t have the rights to publish it)&nbsp;etc.</p>
<h2>Creating our&nbsp;blog</h2>
<p>Each of our Page types is a normal Django Model which inherits from <code>Page</code>. Let&#8217;s suppose that our posts should contain a title, a body and a created date. Add the following to <code>tutorials/models.py</code>:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="kn">from</span> <span class="nn">wagtail.wagtailcore.models</span> <span class="kn">import</span> <span class="n">Page</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailcore.fields</span> <span class="kn">import</span> <span class="n">RichTextField</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailadmin.edit_handlers</span> <span class="kn">import</span> <span class="n">FieldPanel</span>    

<span class="k">class</span> <span class="nc">BlogPage</span><span class="p">(</span><span class="n">Page</span><span class="p">):</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">RichTextField</span><span class="p">()</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="s">&quot;Post date&quot;</span><span class="p">)</span>
    <span class="n">search_name</span> <span class="o">=</span> <span class="s">&quot;Blog Page&quot;</span>

    <span class="n">indexed_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">,</span> <span class="p">)</span>

<span class="n">BlogPage</span><span class="o">.</span><span class="n">content_panels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FieldPanel</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">classname</span><span class="o">=</span><span class="s">&quot;full title&quot;</span><span class="p">),</span>
    <span class="n">FieldPanel</span><span class="p">(</span><span class="s">&#39;date&#39;</span><span class="p">),</span>
    <span class="n">FieldPanel</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">,</span> <span class="n">classname</span><span class="o">=</span><span class="s">&quot;full&quot;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>


<p>and run <code>python manage.py syncdb</code> to create the <code>tutorial_blogpage</code> table. </p>
<p>Now, if you visit again the /admin and click on the &#8220;Add Child Page&#8221; action of &#8220;Welcome to your new Wagtail Site!&#8221; you will see the &#8220;Blog Page&#8221; page and after you click it you will be able to see a form with the Fields you defined <em>and</em> title(title, body, date). The title is a field inherited from Page, along with the fields  in the Promote&nbsp;tab. </p>
<p>In our declaration of BlogPage we added three <code>FieldPanel</code>s on its content_panes. A <code>FieldPanel</code> is a special edit handler for each Field. That is why when you try to edit the body you will see a rich text toolbar that enables you to not only format text but also embed images, documents and even oembed links. If you hadn&#8217;t included the <code>FieldPanel('body', classname="full")</code> then you wouldn&#8217;t see the rich text&nbsp;editor.</p>
<p><img alt="Editing pages in Wagtail" src="http://spapas.github.io/images/wagtail-edit-page.png" /></p>
<p>So now we can add as many posts as we&nbsp;like! </p>
<p>The time has come to take a look at our fine blog post: After we publish our page we click to the view live action&nbsp;and&#8230; </p>
<blockquote>
<p>TemplateDoesNotExist at&nbsp;/hello-world/</p>
<p>tutorial/blog_page.html</p>
</blockquote>
<p>:(</p>
<p>A template seems to be missing &#8212; actually we have totally forgotten about the presentation of our blog &#8212; we&#8217;ll talk about this in the next section&nbsp;!</p>
<p>However, before going there we should also create an Index page type collecting our&nbsp;posts. </p>
<p>For this, we will change our <code>models.py</code> to&nbsp;this:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="kn">from</span> <span class="nn">wagtail.wagtailcore.models</span> <span class="kn">import</span> <span class="n">Page</span><span class="p">,</span> <span class="n">Orderable</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailcore.fields</span> <span class="kn">import</span> <span class="n">RichTextField</span>
<span class="kn">from</span> <span class="nn">wagtail.wagtailadmin.edit_handlers</span> <span class="kn">import</span> <span class="n">FieldPanel</span>  <span class="p">,</span><span class="n">MultiFieldPanel</span><span class="p">,</span><span class="n">InlinePanel</span><span class="p">,</span> <span class="n">PageChooserPanel</span>
<span class="kn">from</span> <span class="nn">modelcluster.fields</span> <span class="kn">import</span> <span class="n">ParentalKey</span>

<span class="k">class</span> <span class="nc">BlogPage</span><span class="p">(</span><span class="n">Page</span><span class="p">):</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">RichTextField</span><span class="p">()</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">(</span><span class="s">&quot;Post date&quot;</span><span class="p">)</span>
    <span class="n">indexed_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">search_name</span> <span class="o">=</span> <span class="s">&quot;Blog Page&quot;</span>

<span class="n">BlogPage</span><span class="o">.</span><span class="n">content_panels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FieldPanel</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">classname</span><span class="o">=</span><span class="s">&quot;full title&quot;</span><span class="p">),</span>
    <span class="n">FieldPanel</span><span class="p">(</span><span class="s">&#39;date&#39;</span><span class="p">),</span>
    <span class="n">FieldPanel</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">,</span> <span class="n">classname</span><span class="o">=</span><span class="s">&quot;full&quot;</span><span class="p">),</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">LinkFields</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">link_page</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s">&#39;wagtailcore.Page&#39;</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;+&#39;</span>
    <span class="p">)</span>

    <span class="n">panels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">PageChooserPanel</span><span class="p">(</span><span class="s">&#39;link_page&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">RelatedLink</span><span class="p">(</span><span class="n">LinkFields</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s">&quot;Link title&quot;</span><span class="p">)</span>
    <span class="n">panels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">FieldPanel</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">),</span>
        <span class="n">MultiFieldPanel</span><span class="p">(</span><span class="n">LinkFields</span><span class="o">.</span><span class="n">panels</span><span class="p">,</span> <span class="s">&quot;Link&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="bp">True</span>


<span class="k">class</span> <span class="nc">BlogIndexPageRelatedLink</span><span class="p">(</span><span class="n">Orderable</span><span class="p">,</span> <span class="n">RelatedLink</span><span class="p">):</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">ParentalKey</span><span class="p">(</span><span class="s">&#39;tutorial.BlogIndexPage&#39;</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s">&#39;related_links&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">BlogIndexPage</span><span class="p">(</span><span class="n">Page</span><span class="p">):</span>
    <span class="n">intro</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
    <span class="n">indexed_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">search_name</span> <span class="o">=</span> <span class="s">&quot;Blog Index Page&quot;</span>

<span class="n">BlogIndexPage</span><span class="o">.</span><span class="n">content_panels</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">FieldPanel</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">classname</span><span class="o">=</span><span class="s">&quot;full title&quot;</span><span class="p">),</span>
    <span class="n">FieldPanel</span><span class="p">(</span><span class="s">&#39;intro&#39;</span><span class="p">,</span> <span class="n">classname</span><span class="o">=</span><span class="s">&quot;full&quot;</span><span class="p">),</span>
    <span class="n">InlinePanel</span><span class="p">(</span><span class="n">BlogIndexPage</span><span class="p">,</span> <span class="s">&#39;related_links&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s">&quot;Related links&quot;</span><span class="p">),</span>
<span class="p">]</span>    
</pre></div>


<p>The above adds a way to put <code>related_links</code> to a <code>BlogIndexPage</code> &#8212; these related_links are the <code>BlogPage</code>s that actually belong to the blog - so now, we can add a blog index page and add all our blog posts to&nbsp;it!</p>
<p>Now that we&#8217;ve created the BlogPage and BlogIndexPage pages it&#8217;s time to take a look at how we will actually display our&nbsp;blog&#8230;</p>
<h2>Creating templates for <em>Page</em>s</h2>
<p>A normal Django template can be used to display each page type. Wagtail either generates automatically (by seperating underscors with capital letters in camelcase for instance BlogIndexPage -&gt; blog_index_page) or you can use the template class attribute. Let&#8217;s add a <code>templates</code> foler within the <code>tutorial</code> foler and add another folder named <code>tutorial</code> inside <code>templates</code> and ten add a file named <code>blog_index_page.html</code> to <code>templates</code> with the following content (you must have the following hierarchy <code>wagtailtutorial/tutorial/templates/tutorial/blog_index_page.html</code>):</p>
<div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>{{ self.title }}<span class="nt">&lt;/h1&gt;</span>
        Intro: {{ self.intro }}
        <span class="nt">&lt;hr</span> <span class="nt">/&gt;</span>
        {% for rl in self.related_links.all %}
            <span class="nt">&lt;p&gt;</span>{{ rl.title }}: <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&#39;{{ rl.link_page.url }}&#39;</span><span class="nt">&gt;</span>{{ rl.link_page }}<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
        {% endfor %}
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<p>So self is the context name of the  BlogPageIndex instance that is used to render this page. Beyond that, it&#8217;s normal&nbsp;django.</p>
<p><img alt="Rendering the Blog Index" src="http://spapas.github.io/images/wagtail-index-template.png" /></p>
<p>Now you can view your Blog Index &#8212; however before clicking on a link to also view your posts add the template for your <code>BlogPost</code> (<code>tutorial/blog_page.html</code>):</p>
<div class="highlight"><pre>{% load rich_text %}
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;h1&gt;</span>{{ self.title }}<span class="nt">&lt;/h1&gt;</span>
        Date: {{ self.date }}
        {{ self.body | richtext }}
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>    
</pre></div>


<p>The extra thing here is the <code>richtext</code> filter which renders a <code>RichTextField</code> correctly. Of course the above templates are just examples - check <code>wagtaildemo</code> for a much better template&nbsp;design.</p>
<p>Woo-hoo &#8212; now I can totally start blogging !!!&nbsp;\o/</p>
<p>&#8230;</p>
<p>&#8230;</p>
<p>But &#8230; when I go to 127.0.0.1:8000 it displays the ugly &#8220;Welcome to your new Wagtail site!&#8221;. I don&#8217;t want to see that any more&nbsp;!!!</p>
<p>No problemo - check the next section of the tutorial&nbsp;:)</p>
<h2>Changing your home&nbsp;page</h2>
<p>Wagtail uses the concept of <em>sites</em> to define groups of pages hosted in the <em>same</em> server. To make more clear what site is, you have to use the good old django admin which can be found at <code>http://127.0.0.1:8000/django-admin/</code>. Check the localhost[default] site entry: You will see that each site has a name, a root page (currently the &#8220;Welcome to your new Wagtail site!&#8221;) and an is_default check. So,  change the root page of the localhost site to your BlogIndexPage and go to <code>http://127.0.0.1:8000/</code> &#8230; Yes ! The blog is alive&nbsp;:)</p>
<h2>Where to go from&nbsp;here</h2>
<p>You are now ready to start adding more pages to your blog, adding functionality to it (don&#8217;t forget that everything is just Django models and templates so you can
change it at will), or even creating a completely different kind of site by adding other Page types. For a more complete site with lots of examples please check 
<a href="https://github.com/torchbox/wagtaildemo">wagtaildemo</a>. There is
no complete documentation yet however you&nbsp;can </p>
<blockquote>
<p>Use the source&nbsp;Luke!</p>
</blockquote></div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2013/12/24/django-dynamic-forms/">Django dynamic forms</a>
      </h1>
      <p class="meta"><time datetime="2013-12-24T14:20:00" pubdate>Τρι 24 Δεκέμβριος 2013</time></p>
</header>

  <div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#describing-a-django-form-in-json" id="id2">Describing a django form in <span class="caps">JSON</span></a></li>
<li><a class="reference internal" href="#creating-the-form-fields" id="id3">Creating the form&nbsp;fields</a></li>
<li><a class="reference internal" href="#creating-the-actual-form" id="id4">Creating the actual&nbsp;form</a></li>
<li><a class="reference internal" href="#using-the-dynamic-form" id="id5">Using the dynamic&nbsp;form</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>To define a form in django, a developer has to create a class which extends
<tt class="docutils literal">django.forms.Form</tt>
and has  a number of attributes extending from <tt class="docutils literal">django.forms.Field</tt>. This makes
it very easy for the developer to create static forms, but creating
dynamic forms whose fields can be changed depending on the data contributed by the
users of the application is not so&nbsp;obvious.</p>
<p>Of course, some people may argue that they can do whatever
they want just by spitting html input tags to their templates, however this totally violates
<span class="caps">DRY</span> and any serious django developer would prefer to write <a class="reference external" href="http://thedailywtf.com/Articles/A_Case_of_the_MUMPS.aspx"><span class="caps">MUMPS</span></a> than creating
html&nbsp;dynamically.</p>
<p>The implementation I will present here had been developed for an old project: In that
project there was a number of services which could be edited dynamically by the
moderators. For each service, the moderators would generate a questionnaire to
get input from the users which would be defined  using <span class="caps">JSON</span>. When the users needed
to submit information for each service, a dynamic django form would be generated
from this <span class="caps">JSON</span> and the answers would be saved to no-<span class="caps">SQL</span> database like&nbsp;MongoDB.</p>
</div>
<div class="section" id="describing-a-django-form-in-json">
<h2><a class="toc-backref" href="#id2">Describing a django form in <span class="caps">JSON</span></a></h2>
<p>A <span class="caps">JSON</span> described django form is just an array of field <span class="caps">JSON</span> objects. Each field
object  has three required attributes: name which is the keyword of the field, label which is
how the label of the field and type which is the type of the input of that field. The
supported types are text, textarea, integer, radio, select, checkbox. Now, depending
on the type of the field, there could be also some more required attributes, for instace
text has a max_length attribute and select has a choices attribute (which is an array
of name/value objects). Also there are two optional attributes,
required with a default value of False and help_text with a default value of&nbsp;&#8221;.</p>
<p>As you can understand these map one by one to the corresponding attributes of the
actual django form fields. An example containing a complete <span class="caps">JSON</span> described form
is the&nbsp;following:</p>
<pre class="code literal-block">
[
    {
        &quot;name&quot;: &quot;firstname&quot;,
        &quot;label&quot;: &quot;First Name&quot;,
        &quot;type&quot;: &quot;text&quot;,
        &quot;max_length&quot;: 25,
        &quot;required&quot;: 1
    },
    {
        &quot;name&quot;: &quot;lastname&quot;,
        &quot;label&quot;: &quot;Last Name&quot;,
        &quot;type&quot;: &quot;text&quot;,
        &quot;max_length&quot;: 25,
        &quot;required&quot;: 1
    },
    {
        &quot;name&quot;: &quot;smallcv&quot;,
        &quot;label&quot;: &quot;Small CV&quot;,
        &quot;type&quot;: &quot;textarea&quot;,
        &quot;help_text&quot;: &quot;Please insert a small CV&quot;
    },
    {
        &quot;name&quot;: &quot;age&quot;,
        &quot;label&quot;: &quot;Age&quot;,
        &quot;type&quot;: &quot;integer&quot;,
        &quot;max_value&quot;: 200,
        &quot;min_value&quot;: 0
    },
    {
        &quot;name&quot;: &quot;marital_status&quot;,
        &quot;label&quot;: &quot;Marital Status&quot;,
        &quot;type&quot;: &quot;radio&quot;,
        &quot;choices&quot;: [
            {&quot;name&quot;: &quot;Single&quot;, &quot;value&quot;:&quot;single&quot;},
            {&quot;name&quot;: &quot;Married&quot;, &quot;value&quot;:&quot;married&quot;},
            {&quot;name&quot;: &quot;Divorced&quot;, &quot;value&quot;:&quot;divorced&quot;},
            {&quot;name&quot;: &quot;Widower&quot;, &quot;value&quot;:&quot;widower&quot;}
        ]
    },
    {
        &quot;name&quot;: &quot;occupation&quot;,
        &quot;label&quot;: &quot;Occupation&quot;,
        &quot;type&quot;: &quot;select&quot;,
        &quot;choices&quot;: [
            {&quot;name&quot;: &quot;Farmer&quot;, &quot;value&quot;:&quot;farmer&quot;},
            {&quot;name&quot;: &quot;Engineer&quot;, &quot;value&quot;:&quot;engineer&quot;},
            {&quot;name&quot;: &quot;Teacher&quot;, &quot;value&quot;:&quot;teacher&quot;},
            {&quot;name&quot;: &quot;Office Clerk&quot;, &quot;value&quot;:&quot;office_clerk&quot;},
            {&quot;name&quot;: &quot;Merchant&quot;, &quot;value&quot;:&quot;merchant&quot;},
            {&quot;name&quot;: &quot;Unemployed&quot;, &quot;value&quot;:&quot;unemployed&quot;},
            {&quot;name&quot;: &quot;Retired&quot;, &quot;value&quot;:&quot;retired&quot;},
            {&quot;name&quot;: &quot;Other&quot;, &quot;value&quot;:&quot;other&quot;}
        ]
    },
    {
        &quot;name&quot;: &quot;internet&quot;,
        &quot;label&quot;: &quot;Internet Access&quot;,
        &quot;type&quot;: &quot;checkbox&quot;
    }
]
</pre>
<p>The above <span class="caps">JSON</span> string can be easily converted to an array of dictionaries with the following&nbsp;code:</p>
<pre class="code literal-block">
import json
fields=json.loads(json_fields)
</pre>
</div>
<div class="section" id="creating-the-form-fields">
<h2><a class="toc-backref" href="#id3">Creating the form&nbsp;fields</a></h2>
<p>The most import part in the django dynamic form creation is to convert the above array
of field-describing dictionaries to actual objects of type <tt class="docutils literal">django.forms.Field</tt>.</p>
<p>To help with that I implemented a class named <tt class="docutils literal">FieldHandler</tt> which gets an
array of field dictionaries and after initialization will have an attribute named <tt class="docutils literal">formfields</tt> which
will be a dictionary with keys the names of each field an values the corresponding <tt class="docutils literal">django.forms.Field</tt> objects. The implementation is as&nbsp;follows:</p>
<pre class="code literal-block">
import django.forms

class FieldHandler():
    formfields = {}
    def __init__(self, fields):
        for field in fields:
            options = self.get_options(field)
            f = getattr(self, &quot;create_field_for_&quot;+field['type'] )(field, options)
            self.formfields[field['name']] = f

    def get_options(self, field):
        options = {}
        options['label'] = field['label']
        options['help_text'] = field.get(&quot;help_text&quot;, None)
        options['required'] = bool(field.get(&quot;required&quot;, 0) )
        return options

    def create_field_for_text(self, field, options):
        options['max_length'] = int(field.get(&quot;max_length&quot;, &quot;20&quot;) )
        return django.forms.CharField(**options)

    def create_field_for_textarea(self, field, options):
        options['max_length'] = int(field.get(&quot;max_value&quot;, &quot;9999&quot;) )
        return django.forms.CharField(widget=django.forms.Textarea, **options)

    def create_field_for_integer(self, field, options):
        options['max_value'] = int(field.get(&quot;max_value&quot;, &quot;999999999&quot;) )
        options['min_value'] = int(field.get(&quot;min_value&quot;, &quot;-999999999&quot;) )
        return django.forms.IntegerField(**options)

    def create_field_for_radio(self, field, options):
        options['choices'] = [ (c['value'], c['name'] ) for c in field['choices'] ]
        return django.forms.ChoiceField(widget=django.forms.RadioSelect,   **options)

    def create_field_for_select(self, field, options):
        options['choices']  = [ (c['value'], c['name'] ) for c in field['choices'] ]
        return django.forms.ChoiceField(  **options)

    def create_field_for_checkbox(self, field, options):
        return django.forms.BooleanField(widget=django.forms.CheckboxInput, **options)
</pre>
<p>As can be seen, in the <tt class="docutils literal">__init__</tt> method, the <tt class="docutils literal">get_options</tt> method is called first which
returns a dictionary with the common options (label, help_text, required). After that,
depending on the type of each field the correct method will be generated with
<tt class="docutils literal">getattr(self, <span class="pre">&quot;create_field_for_&quot;+field['type']</span> )</tt> (so if type is text this
will return a reference to the create_field_for_text method) and then called passing
the field dictinary and the options returned from <tt class="docutils literal">get_options</tt>. Each one of
the <tt class="docutils literal">create_field_for_xxx</tt> methods will extract the required (or optional)
attributes for the specific field type, update options and initialize the correct Field passing
the options as kwargs. Finally the formfields attribute will be updated with the name
and Field&nbsp;object.</p>
</div>
<div class="section" id="creating-the-actual-form">
<h2><a class="toc-backref" href="#id4">Creating the actual&nbsp;form</a></h2>
<p>To create the actual dynamic <tt class="docutils literal">django.forms.Form</tt> I used the function <tt class="docutils literal">get_form</tt>
which receives a string with the json description, parses it to a python array,
creates the array of fields with the help of <tt class="docutils literal">FieldHandler</tt> and then generates
the <tt class="docutils literal">Form</tt> class with <tt class="docutils literal">type</tt> passing it <tt class="docutils literal">django.forms.Form</tt> as a parent
and the array of <tt class="docutils literal">django.forms.Field</tt> from <tt class="docutils literal">FieldHandler</tt> as&nbsp;attributes:</p>
<pre class="code literal-block">
def get_form(jstr):
    fields=json.loads(jstr)
    fh = FieldHandler(fields)
    return type('DynaForm', (django.forms.Form,), fh.formfields )
</pre>
</div>
<div class="section" id="using-the-dynamic-form">
<h2><a class="toc-backref" href="#id5">Using the dynamic&nbsp;form</a></h2>
<p>The result of <tt class="docutils literal">get_form</tt> can be used as a normal form class. As an&nbsp;example:</p>
<pre class="code literal-block">
import dynaform

def dform(request):
    json_form = get_json_form_from_somewhere()
    form_class = dynaform.get_form(json_form)
    data = {}
    if request.method == 'POST':
        form = form_class(request.POST)
        if form.is_valid():
            data = form.cleaned_data
    else:
        form = form_class()

    return render_to_response( &quot;dform.html&quot;, {
        'form': form,  'data': data,
    }, RequestContext(request) )
</pre>
<p>So, we have to get our <span class="caps">JSON</span> form description from somewhere (for instance
a field in a model) and then generate the form class with <tt class="docutils literal">get_form</tt>.
After that we follow the normal procedure of checking if the <tt class="docutils literal">request.method</tt>
is <span class="caps">POST</span> so we pass the <span class="caps">POST</span> data to the form and check if it is value or
we just create an empty form. As a result we just pass the data that was
read from the form to the view for&nbsp;presentation.</p>
</div>
</div>
  		</article>
<div class="pagination">
    <a class="prev" href="http://spapas.github.io/tag\django2.html">&larr; Older</a>

  <br />
</div></div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="http://spapas.github.io/2015/01/21/django-model-auditing/">Django model auditing</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2014/09/15/django-non-html-responses/">Django non-HTML responses</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2014/04/11/django-generic-formviews-for-objects/">Django generic FormViews for objects</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2014/02/13/wagtail-tutorial/">A Wagtail tutorial</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2013/12/24/django-dynamic-forms/">Django dynamic forms</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="http://spapas.github.io/category/css.html">css</a></li>
        <li><a href="http://spapas.github.io/category/django.html">django</a></li>
        <li><a href="http://spapas.github.io/category/flask.html">flask</a></li>
        <li><a href="http://spapas.github.io/category/git.html">git</a></li>
        <li><a href="http://spapas.github.io/category/pelican.html">pelican</a></li>
        <li><a href="http://spapas.github.io/category/python.html">python</a></li>
        <li><a href="http://spapas.github.io/category/spring.html">spring</a></li>
        <li><a href="http://spapas.github.io/category/wagtail.html">wagtail</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="http://spapas.github.io/tag/pelican.html">pelican</a>,    <a href="http://spapas.github.io/tag/google.html">google</a>,    <a href="http://spapas.github.io/tag/nodejs.html">node.js</a>,    <a href="http://spapas.github.io/tag/spring.html">spring</a>,    <a href="http://spapas.github.io/tag/rest.html">rest</a>,    <a href="http://spapas.github.io/tag/design.html">design</a>,    <a href="http://spapas.github.io/tag/auditing.html">auditing</a>,    <a href="http://spapas.github.io/tag/gmail.html">gmail</a>,    <a href="http://spapas.github.io/tag/git.html">git</a>,    <a href="http://spapas.github.io/tag/java.html">java</a>,    <a href="http://spapas.github.io/tag/flask.html">flask</a>,    <a href="http://spapas.github.io/tag/less.html">less</a>,    <a href="http://spapas.github.io/tag/heroku.html">heroku</a>,    <a href="http://spapas.github.io/tag/forms.html">forms</a>,    <a href="http://spapas.github.io/tag/github-pages.html">github-pages</a>,    <a href="http://spapas.github.io/tag/ldap.html">ldap</a>,    <a href="http://spapas.github.io/tag/spring-security.html">spring-security</a>,    <a href="http://spapas.github.io/tag/css.html">css</a>,    <a href="http://spapas.github.io/tag/python.html">python</a>,    <a href="http://spapas.github.io/tag/mongodb.html">mongodb</a>,    <a href="http://spapas.github.io/tag/authentication.html">authentication</a>,    <a href="http://spapas.github.io/tag/class-based-views.html">class-based-views</a>,    <a href="http://spapas.github.io/tag/rst.html">rst</a>,    <a href="http://spapas.github.io/tag/branching.html">branching</a>,    <a href="http://spapas.github.io/tag/github.html">github</a>,    <a href="http://spapas.github.io/tag/windows.html">windows</a>,    <a href="http://spapas.github.io/tag/wagtail.html">wagtail</a>,    <a href="http://spapas.github.io/tag/django.html">django</a>,    <a href="http://spapas.github.io/tag/githubio.html">github.io</a>,    <a href="http://spapas.github.io/tag/static-html.html">static-html</a>,    <a href="http://spapas.github.io/tag/cbv.html">cbv</a>,    <a href="http://spapas.github.io/tag/security.html">security</a>,    <a href="http://spapas.github.io/tag/boostrap-material-design.html">boostrap-material-design</a>  </section>



</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2013-2015  - Serafeim Papastefanos -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44750952-1', 'auto');
    ga('send', 'pageview');
    </script>
	<script type="text/javascript">
	  var disqus_shortname = 'spapas-github-io';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
</body>
</html>
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="5_8DTmIiEq4gFvNAfxAD6TsGOgrMAjp8lQFQvfA6zZc" />
  <title>/var/ - rest</title>
  <meta name="author" content="Serafeim Papastefanos">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="http://spapas.github.io/favicon.png" rel="icon">
  <link href="http://spapas.github.io/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="http://spapas.github.io/theme/js/modernizr-2.0.js"></script>
  <script src="http://spapas.github.io/theme/js/ender.js"></script>
  <script src="http://spapas.github.io/theme/js/octopress.js" type="text/javascript"></script>

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://spapas.github.io/">/var/</a></h1>
    <h2>Various programming stuff</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>



<ul class="main-navigation">
    <li >
    <a href="http://spapas.github.io/category/css.html">Css</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/django.html">Django</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/flask.html">Flask</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/git.html">Git</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/javascript.html">Javascript</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/pelican.html">Pelican</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/python.html">Python</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/spring.html">Spring</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/wagtail.html">Wagtail</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div class="blog-index">
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2015/02/06/python-pusher-rest/">Calling the REST API of Pusher from python</a>
      </h1>
      <p class="meta"><time datetime="2015-02-06T12:20:00" pubdate>Παρ 06 Φεβρουάριος 2015</time></p>
</header>

  <div class="entry-content"><div class="section" id="introduction">
<h2>Introduction</h2>
<p><a class="reference external" href="https://pusher.com/">Pusher</a> is one of the best real time frameworks right now. Using it you can add real time
events in your projects without the need to configure and use <span class="caps">HTTP</span> servers that support
real-time events in your environment. I used it recently in a project and it worked really
good, having a very simple <span class="caps">API</span> and a nice interface for debugging your&nbsp;requests.</p>
<p>The only problem I&#8217;ve found was that the <a class="reference external" href="https://github.com/pusher/pusher_client_python">Pusher python <span class="caps">API</span></a> misses some features that
the APIs for other languages have, specifically finding out the users on a presence&nbsp;channel.</p>
<p>Pusher supports real-time events through the use of &quot;channels&quot;. Each pusher client will
subscribe to a channel and receive messages that are sent to that channel. A special kind
of channel are presence channels which keep a list of their subscribers. You can query the
<a class="reference external" href="https://pusher.com/docs/rest_api">Pusher <span class="caps">REST</span> <span class="caps">API</span></a> (or f.e the Pusher Javascript <span class="caps">API</span>) to find out the names of the users
in a presence channel - however this is <em>not</em> currently possible with the python <span class="caps">API</span>.</p>
<p>Unfortuanately, calling the Pusher <span class="caps">REST</span> <span class="caps">API</span> is <em>not</em> so easy, since it needs a complicated
singining of each request, so I&#8217;ve written this post to help developers that need to call
this <span class="caps">API</span> from python (to get the users of a presence channel or for any other method the
<span class="caps">REST</span> <span class="caps">API</span>&nbsp;supports).</p>
</div>
<div class="section" id="signing-the-request">
<h2>Signing the&nbsp;request</h2>
<p>Quoting from the <a class="reference external" href="https://pusher.com/docs/rest_api">Pusher <span class="caps">REST</span> <span class="caps">API</span></a>, to sign a request we need a signature,&nbsp;which:</p>
<blockquote>
<p>The signature is a <span class="caps">HMAC</span> <span class="caps">SHA256</span> hex digest. This is generated by signing a string made up of the following components concatenated with newline characters&nbsp;\n:</p>
<ul class="simple">
<li>The uppercase request method (e.g. <span class="caps">POST</span>)</li>
<li>The request path (e.g.&nbsp;/some/resource)</li>
<li>The query parameters sorted by key, with keys converted to lowercase, then joined as in the query string. Note that the string must not be url escaped (e.g. given the keys auth_key: foo, Name: Something else, you get auth_key=foo&amp;name=Something&nbsp;else)</li>
</ul>
</blockquote>
<p>So, we need to create a string and then sign it using our Pusher api_key and secret. To help with this, we create a <tt class="docutils literal">Token</tt>
class which will be initialzed with out pusher key/secret and correctly sign a&nbsp;string:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">Token</span><span class="p">(</span><span class="nb">object</span><span class="p">,):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">secret</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span>

    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
</pre></div>
<p>It uses the <tt class="docutils literal">hmac</tt> and <tt class="docutils literal">hashlib</tt> python&nbsp;modules.</p>
</div>
<div class="section" id="generating-the-complete-query-string">
<h2>Generating the complete query&nbsp;string</h2>
<p>We can now create a function that will sign a request using an instance of the above&nbsp;token:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">create_signed_query_string</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">partial_path</span><span class="p">,</span> <span class="n">request_params</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;auth_key&#39;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
        <span class="s">&#39;auth_timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
        <span class="s">&#39;auth_version&#39;</span><span class="p">:</span> <span class="s">&#39;1.0&#39;</span>
    <span class="p">}</span>
    <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request_params</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">params_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;{0}={1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">)</span>

    <span class="n">query_string</span> <span class="o">=</span> <span class="s">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params_list</span><span class="p">)</span>

    <span class="n">sign_data</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="n">partial_path</span><span class="p">,</span> <span class="n">query_string</span><span class="p">])</span>
    <span class="n">query_string</span> <span class="o">+=</span> <span class="s">&#39;&amp;auth_signature=&#39;</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sign_data</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">query_string</span>
</pre></div>
<p><tt class="docutils literal">create_signed_query_string</tt> receives an instance of a <tt class="docutils literal">Token</tt>, the path that we want to request
without the server part (for example <tt class="docutils literal"><span class="pre">/apps/33/users/my-channel</span></tt>)  and a dictionary of
request parameters. It then adds three extra fields to the request parameters (<tt class="docutils literal">auth_key, auth_timestamp, auth_version</tt>)
and creates a list of these parameters in the <tt class="docutils literal">key=value</tt> form, where the keys are alphabetically sorted.
After that it joins the above <tt class="docutils literal">key=value</tt> parameters using <tt class="docutils literal">&amp;</tt> to create the <tt class="docutils literal">query_string</tt> and then it creates the string to be signed (<tt class="docutils literal">sign_data</tt>)
by concatenating the <span class="caps">HTTP</span> methdo (<span class="caps">GET</span>) with the path and the <tt class="docutils literal">query_string</tt>. Finally, it appends the signing result as an extra
query parameter named (<tt class="docutils literal">auth_signature</tt>).</p>
</div>
<div class="section" id="requesting-the-users-of-the-presence-channel">
<h2>Requesting the users of the presence&nbsp;channel</h2>
<p>The <tt class="docutils literal">create_signed_query_string</tt> can now be used to get the users of a presence channel like&nbsp;this:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
    <span class="n">partial_path</span> <span class="o">=</span>  <span class="s">&#39;/apps/{0}/channels/{1}/users&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
    <span class="n">qs</span> <span class="o">=</span> <span class="n">create_signed_query_string</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">partial_path</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">full_path</span> <span class="o">=</span> <span class="s">&#39;http://api.pusherapp.com/{0}?{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">partial_path</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>
</pre></div>
<p>The <tt class="docutils literal">get_users</tt> function will generate the path of the pusher <span class="caps">REST</span> <span class="caps">API</span> (using
our pusher app_id and channel name) and initialize a signing <tt class="docutils literal">Token</tt> using
the pusher key and secret. It will then pass the previous to <tt class="docutils literal">create_signed_query_string</tt>
to generate the complete <tt class="docutils literal">query_string</tt> and generate the <tt class="docutils literal">full_path</tt> to which
a simple <span class="caps">HTTP</span> <span class="caps">GET</span> request is issued. The result will be a <span class="caps">JSON</span> list of the users in the
presence&nbsp;channel.</p>
</div>
<div class="section" id="complete-example">
<h2>Complete&nbsp;example</h2>
<p>A complete example of getting the presence users of a channel is the&nbsp;following:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">hmac</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">app_id</span> <span class="o">=</span> <span class="s">&#39;pusher_app_id&#39;</span>
<span class="n">key</span> <span class="o">=</span> <span class="s">&#39;pusher_key&#39;</span>
<span class="n">secret</span> <span class="o">=</span> <span class="s">&#39;pusher_secret&#39;</span>
<span class="n">channel</span> <span class="o">=</span> <span class="s">&#39;pusher_presence_channel&#39;</span>


<span class="k">class</span> <span class="nc">Token</span><span class="p">(</span><span class="nb">object</span><span class="p">,):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">secret</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secret</span> <span class="o">=</span> <span class="n">secret</span>

    <span class="k">def</span> <span class="nf">sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">create_signed_query_string</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">partial_path</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">request_params</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;auth_key&#39;</span><span class="p">:</span> <span class="n">token</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
        <span class="s">&#39;auth_timestamp&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()),</span>
        <span class="s">&#39;auth_version&#39;</span><span class="p">:</span> <span class="s">&#39;1.0&#39;</span>
    <span class="p">}</span>
    <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request_params</span><span class="p">)</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">params_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">params_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&#39;{0}={1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="p">)</span>

    <span class="n">query_string</span> <span class="o">=</span> <span class="s">&#39;&amp;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">params_list</span><span class="p">)</span>

    <span class="n">sign_data</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">partial_path</span><span class="p">,</span> <span class="n">query_string</span><span class="p">])</span>
    <span class="n">query_string</span> <span class="o">+=</span> <span class="s">&#39;&amp;auth_signature=&#39;</span> <span class="o">+</span> <span class="n">token</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">sign_data</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">query_string</span>


<span class="k">def</span> <span class="nf">get_users</span><span class="p">(</span><span class="n">channel</span><span class="p">):</span>
    <span class="n">partial_path</span> <span class="o">=</span>  <span class="s">&#39;/apps/{0}/channels/{1}/users&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">app_id</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">Token</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
    <span class="n">qs</span> <span class="o">=</span>  <span class="n">create_signed_query_string</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">partial_path</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span> <span class="p">{})</span>
    <span class="n">full_path</span> <span class="o">=</span> <span class="s">&#39;http://api.pusherapp.com/{0}?{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">partial_path</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span>

<span class="k">print</span> <span class="n">get_users</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>With the above we are able to not only easily get the users of a Pusher presence
channel in python but to also call any method we want from the Pusher <span class="caps">REST</span> <span class="caps">API</span> by implementing a function
similar to  <tt class="docutils literal">get_users</tt>.</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2014/06/30/rest-flask-mongodb-heroku/">Implementing a simple, Heroku-hosted REST service using Flask and mongoDB</a>
      </h1>
      <p class="meta"><time datetime="2014-06-30T15:23:00" pubdate>Δευ 30 Ιούνιος 2014</time></p>
</header>

  <div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#requirements" id="id2">Requirements</a></li>
<li><a class="reference internal" href="#implementing-the-rest-service" id="id3">Implementing the <span class="caps">REST</span>&nbsp;service</a></li>
<li><a class="reference internal" href="#testing-it-locally" id="id4">Testing it&nbsp;locally</a></li>
<li><a class="reference internal" href="#deploying-to-heroku" id="id5">Deploying to&nbsp;Heroku</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>In the following, I will describe how I used <a class="reference external" href="http://flask.pocoo.org/">Flask</a>, a very nice web <em>microframework</em> for python along  with <a class="reference external" href="http://www.mongodb.org/">mongoDB</a>, the most
popular No-<span class="caps">SQL</span> database to implement a simple <span class="caps">REST</span> service that was hosted on <a class="reference external" href="https://dashboard.heroku.com/apps">Heroku</a>. This <span class="caps">REST</span> service would get readings from
a number of sensors from an Android&nbsp;device.</p>
<p>I chose Flask instead of Django mainly because the <span class="caps">REST</span> service that I needed to implement would be very simple and most of
the Django bells and whistles (<span class="caps">ORM</span>, auth, admin, etc) wouldn&#8217;t be needed anyway. Also, Flask is much quicker to set-up than
Django since almost everything (views, urls, etc) can be put inside one python&nbsp;module.</p>
<p>Concerning the choice of a NoSQL persistance solution (mongoDB), I wanted to have a table (or collection as it is called in the
mongoDB world) of readings from the sensor. Each reading would just have a timestamp and various other
arbitrary data depending on the type of the reading, so saving it as a <span class="caps">JSON</span> document in a NoSQL database is a good&nbsp;solution.</p>
<p>Finally, all the above will be deployed to Heroku which offers some great services for deploying python code in the&nbsp;cloud.</p>
</div>
<div class="section" id="requirements">
<h2><a class="toc-backref" href="#id2">Requirements</a></h2>
<p>I propose creating a file named <tt class="docutils literal">requirements.txt</tt> that will host the required packages for your project, so you will be
able to setup your projects after creating a virtual environment with <a class="reference external" href="http://virtualenv.readthedocs.org/en/latest/">virtualenv</a> just by running <tt class="docutils literal">pip install <span class="pre">-r</span> requirements.txt</tt>.
Also, the requirements.txt is required for deploying python to&nbsp;Heroku.</p>
<p>So, for my case, the contents of requirements.txt are the&nbsp;following:</p>
<pre class="code literal-block">
Flask==0.10.1
Flask-PyMongo==0.3.0
Flask-RESTful==0.2.12
Jinja2==2.7.3
MarkupSafe==0.23
Werkzeug==0.9.6
aniso8601==0.82
gunicorn==19.0.0
itsdangerous==0.24
pymongo==2.7.1
pytz==2014.4
six==1.7.2
</pre>
<ul class="simple">
<li>Flask-PyMongo is a simple wrapper for Flask around pymongo which is the python mongoDB&nbsp;driver.</li>
<li>Flask-RESTful is a simple library for creating <span class="caps">REST</span> APIs - it needs aniso8601 and&nbsp;pytz.</li>
<li>Jinja2 is the template library for Flask (we won&#8217;t use it but it is required by Flask installation) - it needs&nbsp;MarkupSafe.</li>
<li>Werkzeug is a <span class="caps">WSGI</span> utility library - required by&nbsp;Flask</li>
<li>gunicorn is a <span class="caps">WSGI</span> <span class="caps">HTTP</span> server - needed for deployment to&nbsp;Heroku</li>
<li>itsdangerous is used to sign data for usage in untrusted&nbsp;environments</li>
<li>six is the python 2/3 compatibility&nbsp;layer</li>
</ul>
</div>
<div class="section" id="implementing-the-rest-service">
<h2><a class="toc-backref" href="#id3">Implementing the <span class="caps">REST</span>&nbsp;service</a></h2>
<p>Instead of using just one single file for our Flask web application, we will create a python module to contain it and a
file named <tt class="docutils literal">runserver.py</tt> that will start a local development server to test&nbsp;it:</p>
<p>So, in the same folder as the <tt class="docutils literal">requirements.txt</tt> create a folder named <tt class="docutils literal">flask_rest_service</tt> and in there put
two files: <tt class="docutils literal">__init__.py</tt> and <tt class="docutils literal">resources.py</tt>.</p>
<p>The <tt class="docutils literal">__init__.py</tt> initializes our Flask application, our mongoDB connection and our Flask-RESTful&nbsp;api:</p>
<pre class="code literal-block">
import os
from flask import Flask
from flask.ext import restful
from flask.ext.pymongo import PyMongo
from flask import make_response
from bson.json_util import dumps

MONGO_URL = os.environ.get('MONGO_URL')
if not MONGO_URL:
    MONGO_URL = &quot;mongodb://localhost:27017/rest&quot;;

app = Flask(__name__)

app.config['MONGO_URI'] = MONGO_URL
mongo = PyMongo(app)

def output_json(obj, code, headers=None):
    resp = make_response(dumps(obj), code)
    resp.headers.extend(headers or {})
    return resp

DEFAULT_REPRESENTATIONS = {'application/json': output_json}
api = restful.Api(app)
api.representations = DEFAULT_REPRESENTATIONS

import flask_rest_service.resources
</pre>
<p>So what happens here? After the imports, we check if we have a MONGO_URL environment variable. This is
how we set options in Heroku. If such option does not exist in the environment then we are in our
development environment so we set it to the localhost (we must have a running mongoDB installation in
our dev&nbsp;environment).</p>
<p>In the next lines, we initialize our Flask application and our mongoDB connection (pymongo
uses a <tt class="docutils literal">MONGO_URI</tt> configuration option to know the database <span class="caps">URI</span>).</p>
<p>The <tt class="docutils literal">output_json</tt> is used to dump the <span class="caps">BSON</span> encoded mongoDB objects to <span class="caps">JSON</span> and was borrowed from
<a class="reference external" href="http://blog.alienretro.com/using-mongodb-with-flask-restful/">alienretro&#8217;s blog</a> &#8212; we initialize our restful <span class="caps">REST</span> <span class="caps">API</span> with this&nbsp;function.</p>
<p>Finally, we import the <tt class="docutils literal">resources.py</tt> module which actually defines our <span class="caps">REST</span>&nbsp;resources.</p>
<pre class="code literal-block">
import json
from flask import request, abort
from flask.ext import restful
from flask.ext.restful import reqparse
from flask_rest_service import app, api, mongo
from bson.objectid import ObjectId

class ReadingList(restful.Resource):
    def __init__(self, *args, **kwargs):
        self.parser = reqparse.RequestParser()
        self.parser.add_argument('reading', type=str)
        super(ReadingList, self).__init__()

    def get(self):
        return  [x for x in mongo.db.readings.find()]

    def post(self):
        args = self.parser.parse_args()
        if not args['reading']:
            abort(400)

        jo = json.loads(args['reading'])
        reading_id =  mongo.db.readings.insert(jo)
        return mongo.db.readings.find_one({&quot;_id&quot;: reading_id})


class Reading(restful.Resource):
    def get(self, reading_id):
        return mongo.db.readings.find_one_or_404({&quot;_id&quot;: reading_id})

    def delete(self, reading_id):
        mongo.db.readings.find_one_or_404({&quot;_id&quot;: reading_id})
        mongo.db.readings.remove({&quot;_id&quot;: reading_id})
        return '', 204


class Root(restful.Resource):
    def get(self):
        return {
            'status': 'OK',
            'mongo': str(mongo.db),
        }

api.add_resource(Root, '/')
api.add_resource(ReadingList, '/readings/')
api.add_resource(Reading, '/readings/&lt;ObjectId:reading_id&gt;')
</pre>
<p>Here we define three <tt class="docutils literal">Resource</tt> classes and add them to our previously defined <tt class="docutils literal">api</tt>: <tt class="docutils literal">Root</tt>, <tt class="docutils literal">Reading</tt> and <tt class="docutils literal">ReadingList</tt>.</p>
<p><tt class="docutils literal">Root</tt> just returns a dictionary with an <span class="caps">OK</span> status and some info on our mongodb&nbsp;connection.</p>
<p><tt class="docutils literal">Reading</tt> has gets an ObjectId
(which is the mongodb primary key) as a parameter and depending on the <span class="caps">HTTP</span> operation, it returns the reading with that
id when receiving an <tt class="docutils literal"><span class="caps">HTTP</span> <span class="caps">GET</span></tt> and deletes the reading with that id when receiving an <tt class="docutils literal"><span class="caps">HTTP</span> <span class="caps">DELETE</span></tt>.</p>
<p><tt class="docutils literal">ReadingList</tt> will return all readings when receiving an <tt class="docutils literal"><span class="caps">HTTP</span> <span class="caps">GET</span></tt> and will create a new reading when
receiving an <tt class="docutils literal"><span class="caps">HTTP</span> <span class="caps">POST</span></tt> The <tt class="docutils literal">post</tt> function uses the parser defined in <tt class="docutils literal">__init__</tt> which requires
a <tt class="docutils literal">reading</tt> parameter with the actual reading to be&nbsp;inserted.</p>
</div>
<div class="section" id="testing-it-locally">
<h2><a class="toc-backref" href="#id4">Testing it&nbsp;locally</a></h2>
<p>In order to run the development server, you will need to install and start mongodb locally which is beyond the scope of this post. After that
create a file named <tt class="docutils literal">runserver.py</tt> in the same folder as with the <tt class="docutils literal">requirements.txt</tt>
and the <tt class="docutils literal">flask_rest_service</tt> folder. The contents of this file should&nbsp;be:</p>
<pre class="code literal-block">
from flask_rest_service import app
app.run(debug=True)
</pre>
<p>When you run this file with <tt class="docutils literal">python runserver.py</tt> you should be able top visit your rest service at <a class="reference external" href="http://localhost:5000">http://localhost:5000</a> and get
an &quot;<span class="caps">OK</span>&quot;&nbsp;status.</p>
</div>
<div class="section" id="deploying-to-heroku">
<h2><a class="toc-backref" href="#id5">Deploying to&nbsp;Heroku</a></h2>
<p>To deploy to Heroku, you must create a <tt class="docutils literal">Procfile</tt> that contains the workers of your application. In our case, the
<tt class="docutils literal">Procfile</tt> should contain the&nbsp;following:</p>
<pre class="code literal-block">
web: gunicorn flask_rest_service:app
</pre>
<p>Also, you should add a .gitignore file with the&nbsp;following:</p>
<pre class="code literal-block">
*.pyc
</pre>
<p>Finally, to deploy your application to Heroku you can follow the instructions here: <a class="reference external" href="https://devcenter.heroku.com/articles/getting-started-with-python">https://devcenter.heroku.com/articles/getting-started-with-python</a>:</p>
<ul class="simple">
<li>Initialize a git repository and commit&nbsp;everything:</li>
</ul>
<pre class="code literal-block">
git init
git add .
git commit -m
</pre>
<ul class="simple">
<li>Create a new Heroku application (after logging in to heroku with <tt class="docutils literal">heroku login</tt>) and set the MONGO_URL environment variable (of course you have to obtain ths MONGO_URL variable for your heroku envirotnment by adding a mongoDB&nbsp;database):</li>
</ul>
<pre class="code literal-block">
heroku create
heroku config:set MONGO_URL=mongodb://user:pass&#64;mongoprovider.com:27409/rest
</pre>
<ul class="simple">
<li>And finally push your master branch to the heroku remote&nbsp;repository:</li>
</ul>
<pre class="code literal-block">
git push heroku master
</pre>
<p>If everything went ok you should be able to start a worker for your application, check that the worker is running, and finally visit&nbsp;it:</p>
<pre class="code literal-block">
heroku ps:scale web=1
heroku ps
heroku open
</pre>
<p>If everything was ok you should see an status-<span class="caps">OK</span> <span class="caps">JSON</span>&nbsp;!</p>
</div>
</div>
  		</article>
<div class="pagination">

  <br />
</div></div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="http://spapas.github.io/2015/02/06/python-pusher-rest/">Calling the REST API of Pusher from python</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2014/06/30/rest-flask-mongodb-heroku/">Implementing a simple, Heroku-hosted REST service using Flask and mongoDB</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="http://spapas.github.io/category/css.html">css</a></li>
        <li><a href="http://spapas.github.io/category/django.html">django</a></li>
        <li><a href="http://spapas.github.io/category/flask.html">flask</a></li>
        <li><a href="http://spapas.github.io/category/git.html">git</a></li>
        <li><a href="http://spapas.github.io/category/javascript.html">javascript</a></li>
        <li><a href="http://spapas.github.io/category/pelican.html">pelican</a></li>
        <li><a href="http://spapas.github.io/category/python.html">python</a></li>
        <li><a href="http://spapas.github.io/category/spring.html">spring</a></li>
        <li><a href="http://spapas.github.io/category/wagtail.html">wagtail</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="http://spapas.github.io/tag/pelican.html">pelican</a>,    <a href="http://spapas.github.io/tag/tasks.html">tasks</a>,    <a href="http://spapas.github.io/tag/less.html">less</a>,    <a href="http://spapas.github.io/tag/spring.html">spring</a>,    <a href="http://spapas.github.io/tag/rest.html">rest</a>,    <a href="http://spapas.github.io/tag/google.html">google</a>,    <a href="http://spapas.github.io/tag/cbv.html">cbv</a>,    <a href="http://spapas.github.io/tag/scheduling.html">scheduling</a>,    <a href="http://spapas.github.io/tag/auditing.html">auditing</a>,    <a href="http://spapas.github.io/tag/gmail.html">gmail</a>,    <a href="http://spapas.github.io/tag/git.html">git</a>,    <a href="http://spapas.github.io/tag/java.html">java</a>,    <a href="http://spapas.github.io/tag/rq.html">rq</a>,    <a href="http://spapas.github.io/tag/uglify.html">uglify</a>,    <a href="http://spapas.github.io/tag/django-rq.html">django-rq</a>,    <a href="http://spapas.github.io/tag/nodejs.html">node.js</a>,    <a href="http://spapas.github.io/tag/redis.html">redis</a>,    <a href="http://spapas.github.io/tag/heroku.html">heroku</a>,    <a href="http://spapas.github.io/tag/forms.html">forms</a>,    <a href="http://spapas.github.io/tag/github-pages.html">github-pages</a>,    <a href="http://spapas.github.io/tag/404.html">404</a>,    <a href="http://spapas.github.io/tag/ldap.html">ldap</a>,    <a href="http://spapas.github.io/tag/spring-security.html">spring-security</a>,    <a href="http://spapas.github.io/tag/css.html">css</a>,    <a href="http://spapas.github.io/tag/node.html">node</a>,    <a href="http://spapas.github.io/tag/javascript.html">javascript</a>,    <a href="http://spapas.github.io/tag/jobs.html">jobs</a>,    <a href="http://spapas.github.io/tag/watchify.html">watchify</a>,    <a href="http://spapas.github.io/tag/python.html">python</a>,    <a href="http://spapas.github.io/tag/mongodb.html">mongodb</a>,    <a href="http://spapas.github.io/tag/static-html.html">static-html</a>,    <a href="http://spapas.github.io/tag/authentication.html">authentication</a>,    <a href="http://spapas.github.io/tag/class-based-views.html">class-based-views</a>,    <a href="http://spapas.github.io/tag/npm.html">npm</a>,    <a href="http://spapas.github.io/tag/rst.html">rst</a>,    <a href="http://spapas.github.io/tag/generic.html">generic</a>,    <a href="http://spapas.github.io/tag/browserify.html">browserify</a>,    <a href="http://spapas.github.io/tag/branching.html">branching</a>,    <a href="http://spapas.github.io/tag/design.html">design</a>,    <a href="http://spapas.github.io/tag/github.html">github</a>,    <a href="http://spapas.github.io/tag/pusher.html">pusher</a>,    <a href="http://spapas.github.io/tag/windows.html">windows</a>,    <a href="http://spapas.github.io/tag/wagtail.html">wagtail</a>,    <a href="http://spapas.github.io/tag/django.html">django</a>,    <a href="http://spapas.github.io/tag/flask.html">flask</a>,    <a href="http://spapas.github.io/tag/githubio.html">github.io</a>,    <a href="http://spapas.github.io/tag/error.html">error</a>,    <a href="http://spapas.github.io/tag/debug.html">debug</a>,    <a href="http://spapas.github.io/tag/asynchronous.html">asynchronous</a>,    <a href="http://spapas.github.io/tag/security.html">security</a>,    <a href="http://spapas.github.io/tag/boostrap-material-design.html">boostrap-material-design</a>  </section>



</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2014-2015  - Serafeim Papastefanos -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44750952-1', 'auto');
    ga('send', 'pageview');
    </script>
	<script type="text/javascript">
	  var disqus_shortname = 'spapas-github-io';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
</body>
</html>
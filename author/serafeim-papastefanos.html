<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="5_8DTmIiEq4gFvNAfxAD6TsGOgrMAjp8lQFQvfA6zZc" />
  <title>/var/ - Articles by Serafeim Papastefanos</title>
  <meta name="author" content="Serafeim Papastefanos">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="http://spapas.github.io/favicon.png" rel="icon">
  <link href="http://spapas.github.io/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="http://spapas.github.io/theme/js/modernizr-2.0.js"></script>
  <script src="http://spapas.github.io/theme/js/ender.js"></script>
  <script src="http://spapas.github.io/theme/js/octopress.js" type="text/javascript"></script>

  <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="http://spapas.github.io/">/var/</a></h1>
    <h2>Various programming stuff</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>



<ul class="main-navigation">
    <li >
    <a href="http://spapas.github.io/category/css.html">Css</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/django.html">Django</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/flask.html">Flask</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/git.html">Git</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/pelican.html">Pelican</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/python.html">Python</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/spring.html">Spring</a>
    </li>
    <li >
    <a href="http://spapas.github.io/category/wagtail.html">Wagtail</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div class="blog-index">
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2014/12/16/change-bootstrap-material-primary-color/">Change the primary color of bootstrap material design</a>
      </h1>
      <p class="meta"><time datetime="2014-12-16T16:20:00" pubdate>Τρι 16 Δεκέμβριος 2014</time></p>
</header>

  <div class="entry-content"><div class="section" id="introduction">
<h2>Introduction</h2>
<p><a class="reference external" href="https://github.com/FezVrasta/bootstrap-material-design">Bootstrap Material Design</a> is a great theme that sits on top of <a class="reference external" href="http://getbootstrap.com/">Bootstrap</a> and transforms it to
<a class="reference external" href="http://www.google.com/design/spec/material-design/introduction.html">Material Design</a>! The great thing about Bootstrap Material Design is that you just need to include
its css and js files after your Bootstrap files and&nbsp;&#8230;</p>
<p>boom! Your page is Material Design&nbsp;compatible!</p>
<object data="https://google.github.io/material-design-icons/action/svg/ic_thumb_up_24px.svg" type="image/svg+xml">
</object>
<p>A nice feature of Bootstrap Material Design is that you can change its default color to a new one (I
don&#8217;t really like the current - greenish one). This is easy for people with less skills however I
found it rather challenging when I tried it. That&#8217;s why I will present a step by step tutorial on
changing the default primary color of the Bootstrap Material Design&nbsp;theme:</p>
</div>
<div class="section" id="step-1-get-the-code">
<h2>Step 1: Get the&nbsp;code</h2>
<p>Use git to make a local clone of the project with <tt class="docutils literal">git clone <span class="pre">https://github.com/FezVrasta/bootstrap-material-design.git</span></tt>. This will create a directory
named <tt class="docutils literal"><span class="pre">bootstrap-material-design</span></tt>. Or you can download the latest version of the code using (<a class="reference external" href="https://github.com/FezVrasta/bootstrap-material-design/archive/master.zip">https://github.com/FezVrasta/bootstrap-material-design/archive/master.zip</a>)
and unzip it to the <tt class="docutils literal"><span class="pre">bootstrap-material-design</span></tt> directory.</p>
</div>
<div class="section" id="step-2-install-node-js-and-npm">
<h2>Step 2: Install node.js and&nbsp;npm</h2>
<p>You need to have <a class="reference external" href="http://nodejs.org/">node.js</a> and npm installed in your system - this is something very easy so I won&#8217;t go into any details about this. After you have installed
both node.js and npm you need to put them in your path so that you&#8217;ll be able to run <tt class="docutils literal">npm <span class="pre">-v</span></tt> without errors and receive something like <tt class="docutils literal">1.4.14</tt>.</p>
</div>
<div class="section" id="step-3-install-less">
<h2>Step 3: Install&nbsp;less</h2>
<p><a class="reference external" href="http://lesscss.org/">less</a> is a <span class="caps">CSS</span> preprocessor in which Bootstrap Material Design has been written. To install it, just enter the command <tt class="docutils literal">npm install <span class="pre">-g</span> less</tt>. After that
you should have a command named <tt class="docutils literal">lessc</tt> which, when run would output something like: <tt class="docutils literal">lessc 2.1.1 (Less Compiler) [JavaScript]</tt>.</p>
</div>
<div class="section" id="step-4-create-the-customizations-files">
<h2>Step 4: Create the customizations&nbsp;files</h2>
<p>Go to the directory where you cloned (or unzipped) the Bootstrap Material Design code and create a file named <tt class="docutils literal">custom.less</tt> (so, that file should be
in the same folder as with <tt class="docutils literal">bower.json</tt>, <tt class="docutils literal">Gruntfile.js</tt> etc) with the following&nbsp;contents:</p>
<pre class="code literal-block">
&#64;import &quot;less/material-wfont.less&quot;;

// Override &#64;primary color with one took from _colors.less
&#64;primary: &#64;indigo;
</pre>
<p>(I wanted to use the indigo color as my primary one - you may of course use whichever color from the ones defined in <tt class="docutils literal">less/_variables.less</tt> you&nbsp;like)</p>
<p>This file may contain other default values for variables - if I find anything useful I will add it to this post (also please reply with any&nbsp;recommendations).</p>
</div>
<div class="section" id="step-5-create-your-custom-material-css-file">
<h2>Step 5: Create your custom material css&nbsp;file</h2>
<p>Finally, run the following command: <tt class="docutils literal">lessc custom.less&nbsp; &gt; <span class="pre">material-custom.css</span></tt>. This will create a file named <tt class="docutils literal"><span class="pre">material-custom.css</span></tt> that contains your
custom version of Bootstrap Material Design! If you want your <tt class="docutils literal"><span class="pre">material-custom.css</span></tt> to be compressed, add the <tt class="docutils literal"><span class="pre">-x</span></tt> option like this:  <tt class="docutils literal">lessc <span class="pre">-x</span> custom.less&nbsp; &gt; <span class="pre">material-custom.css</span></tt>.</p>
<p>You may now include <tt class="docutils literal"><span class="pre">material-custom.css</span></tt> instead of <tt class="docutils literal">material.css</tt> (or the minified version of it) to your projects and you&#8217;ll have your own primary&nbsp;color!</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2014/10/23/retrieve-gmail-blocked-attachments/">Retrieving Gmail blocked attachments</a>
      </h1>
      <p class="meta"><time datetime="2014-10-23T14:20:00" pubdate>Πεμ 23 Οκτώβριος 2014</time></p>
</header>

  <div class="entry-content"><p>Before services like Dropbox were widely available, some people (including me) were using
their Gmail account as a primitive backup solution: Compress your directory and send it to
your gmail. There. Backup&nbsp;complete.</p>
<p>However, nothing is so&nbsp;easy&#8230;</p>
<p>Recently, I wanted to retrieve one of these backups, a .rar containing the complete
source code (since it was written in TeX) of my PhD thesis. The problem was that Gmail blocked the access to these attachments&nbsp;saying</p>
<blockquote>
Anti-virus warning - 1 attachment contains a virus or blocked file. Downloading this attachment is disabled.</blockquote>
<p>probably because I had a number of .bat files inside that .rar archive to automate my work&nbsp;:(</p>
<p>Now what&nbsp;?</p>
<p>After searching the internet and not founding any solutions, I tried the options that gmail gives for each email. One
particular one cought my interest: <em>Show&nbsp;original</em></p>
<img alt="Here it is!" src="/images/show_original.png" style="width: 780px;" />
<p>Clicking this option opened a text file with the original, <span class="caps">MIME</span> encoded message. The interesting thing of course&nbsp;was</p>
<pre class="code literal-block">
------=_NextPart_000_004F_01CA0AED.E63C2A30
Content-Type: application/octet-stream;
      name=&quot;phdstuff.rar&quot;
Content-Transfer-Encoding: base64
Content-Disposition: attachment;
      filename=&quot;phdstuff.rar&quot;

UmFyIRoHAM+QcwAADQAAAAAAAAB0f3TAgCwANAMAAFQEAAACRbXCx8lr9TodMwwAIAAAAG5ld2Zp
bmFsLnR4dA3dEQzM082BF7sB+D3q6QPUNEfwG7vHQgNkiQDTkGvfhOE4mNltIJJlBFMOCQPzPeKD
...
</pre>
<p>So the whole attachment was contained in that text file, encoded in base64! Now I just
needed to extract it from the email and convert it back to&nbsp;binary.</p>
<p>This was very easy to do using Python - some people <a class="reference external" href="http://stackoverflow.com/questions/4067937/getting-mail-attachment-to-python-file-object">had already asked the same thing on <span class="caps">SO</span></a>.
So here&#8217;s a simple program that gets an email in text/mime format as input and dumps all&nbsp;attachments:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">email</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Please enter a file to extract attachments from&quot;</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message_from_file</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">get_payload</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">pl</span><span class="o">.</span><span class="n">get_filename</span><span class="p">():</span> <span class="c"># if it is an attachment</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(),</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="n">decode</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
</pre></div>
<p>Save this to a file named <tt class="docutils literal">get_attachments.py</tt> and, after saving the original message to a file
named <tt class="docutils literal">0.txt</tt> run <tt class="docutils literal">python get_attachments.py 0.txt</tt> and you&#8217;ll see the attachments of your email in the same&nbsp;folder!</p>
<blockquote>
Disclaimer: I have to warn you that since Gmail claims that an attachment is <em>not safe</em> it may be <strong>actually not safe</strong>. So
you must be 100% sure that you know what you are doing before retrievening your email attachments like this.</blockquote>
<p><strong>Update</strong>: Stefan <a class="reference external" href="https://gist.github.com/stefansundin/a99bbfb6cda873d14fd2">created an improved version</a> of the attachment extractor which is also compatible with Python&nbsp;3.4!</p>
<p><strong>Update, 12 January 2015</strong>: Ivana (at the comments section) proposed a different solution that may work
for some files: <em>Use a mobile Gmail client (I tested it with Android) and &quot;Save to Drive&quot; your attachment.
You&#8217;ll then be able to download it from the Google&nbsp;Drive!</em></p>
<p>I am not sure if this works for all attachments,
however it worked for the source of my PhD thesis! I&#8217;m writing it may not work for all attachments because
when you download something from Google Drive it does a virus check so it may not allow you to download the
attachment and then  you&#8217;ll still need to do it manually using the method below (however <strong>in that case you
must be even more cautious for the case the attachment actualyl contains a malicious file</strong>).</p>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2014/09/15/django-non-html-responses/">Django non-HTML responses</a>
      </h1>
      <p class="meta"><time datetime="2014-09-15T14:20:00" pubdate>Δευ 15 Σεπτέμβριος 2014</time></p>
</header>

  <div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#how-are-cbvs-rendered" id="id2">How are CBVs&nbsp;rendered</a></li>
<li><a class="reference internal" href="#rendering-to-non-html" id="id3">Rendering to non-<span class="caps">HTML</span></a></li>
<li><a class="reference internal" href="#a-non-html-mixin" id="id4">A non-<span class="caps">HTML</span>&nbsp;mixin</a></li>
<li><a class="reference internal" href="#a-more-complex-example" id="id5">A more complex&nbsp;example</a></li>
<li><a class="reference internal" href="#conclusion" id="id6">Conclusion</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>I have already written about the many advantages (<span class="caps">DRY</span>!) of using <a class="reference external" href="http://spapas.github.io/2014/04/11/django-generic-formviews-for-objects/">CBVs in a previous article.</a>
In this article I will present the correct (pythonic) way to allow a normal <span class="caps">CBV</span> to return non-<span class="caps">HTML</span> responses, like <span class="caps">PDF</span>, <span class="caps">CSV</span>, <span class="caps">XSL</span>&nbsp;etc.</p>
</div>
<div class="section" id="how-are-cbvs-rendered">
<h2><a class="toc-backref" href="#id2">How are CBVs&nbsp;rendered</a></h2>
<p>Before proceeding, we need to understand how CBVs are rendered. By walking through the
class hierarchy in the <a class="reference external" href="http://ccbv.co.uk/"><span class="caps">CBV</span> inspector</a>, we can see that
all the normal Django CBVs (DetailView, CreateView, TemplateView etc) are using a mixin
named <a class="reference external" href="http://ccbv.co.uk/projects/Django/1.7/django.views.generic.base/TemplateResponseMixin/">TemplateResponseMixin</a> which defines a method named <tt class="docutils literal">render_to_response</tt>. This
is the method that is used for rendering the output of the Views. Let&#8217;s take a look at
<a class="reference external" href="http://ccbv.co.uk/projects/Django/1.7/django.views.generic.base/TemplateResponseMixin/">how it is defined</a> (I&#8217;ll remove the&nbsp;comments):</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">TemplateResponseMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="n">template_name</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="n">response_class</span> <span class="o">=</span> <span class="n">TemplateResponse</span>
  <span class="n">content_type</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
      <span class="n">response_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;content_type&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_type</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span><span class="p">(</span>
          <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
          <span class="n">template</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_template_names</span><span class="p">(),</span>
          <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span>
          <span class="o">**</span><span class="n">response_kwargs</span>
      <span class="p">)</span>

  <span class="k">def</span> <span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
              <span class="s">&quot;TemplateResponseMixin requires either a definition of &quot;</span>
              <span class="s">&quot;&#39;template_name&#39; or an implementation of &#39;get_template_names()&#39;&quot;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">]</span>
</pre></div>
<p>This method will try to find out which html template should be used to render the View
(using the  <tt class="docutils literal">get_template_names</tt> method and template_name attribute of the mixin) and
then render this view by instantiating an instance of the <tt class="docutils literal">TemplateResponse</tt> class
(as defined in the <tt class="docutils literal">response_class</tt> attribute)
and passing the request, template, context and other response_args to&nbsp;it.</p>
<p>The <a class="reference external" href="https://github.com/django/django/blob/master/django/template/response.py">TemplateResponse</a> class which is instantiated in the <tt class="docutils literal">render_to_response</tt> method
inherits from a normal <tt class="docutils literal">HttpResponse</tt> and is used to render
the template passed to it as a&nbsp;parameter.</p>
</div>
<div class="section" id="rendering-to-non-html">
<h2><a class="toc-backref" href="#id3">Rendering to non-<span class="caps">HTML</span></a></h2>
<p>From the previous discussion we can conclude that if your non-<span class="caps">HTML</span> response <em>needs</em>
a template then you just need to create a subclass of <tt class="docutils literal">TemplateResponse</tt> and
assign it to the <tt class="docutils literal">response_class</tt> attribute (and also change the <tt class="docutils literal">content_type</tt>
attribute). On the other hand, if your non-<span class="caps">HTML</span> respond does not need a template
to be rendered then you have to override <tt class="docutils literal">render_to_response</tt> completely
(since the template parameter does not need to be passed now) and either define
a subclass of HttpResponse or do the rendering in the&nbsp;render_to_response.</p>
<p>Since almost always you won&#8217;t need a template to create a non-<span class="caps">HTML</span> view and because
I believe that the solution is <span class="caps">DRY</span>-enough by implementing the rendering code to
the <tt class="docutils literal">render_to_response</tt> method (<em>without</em> subclassing <tt class="docutils literal">HttpResponse</tt>) I will
implement a mixin that does exactly&nbsp;that.</p>
<p>Subclassing <tt class="docutils literal">HttpResponse</tt> will not make our design more <span class="caps">DRY</span> because for every
subclass of <tt class="docutils literal">HttpResponse</tt> the <tt class="docutils literal">render_to_response</tt> method would also need to
be modified (by subclassing <tt class="docutils literal">TemplateResponseMixin) to instantiate the subclass of ``HttpResponse</tt> with the correct parameters.
For instance, the existing <tt class="docutils literal">TemplateResponseMixin</tt> cannot be used if the subclass
of <tt class="docutils literal">HttpResponse</tt> does not take a template as a parameter (solutions like
passing None to the template parameter are signals of bad&nbsp;design).</p>
<p>In any case, changing just the <tt class="docutils literal">render_to_response</tt> method using a Mixin is in my opinion the best solution
to the above problem.
A <a class="reference external" href="http://stackoverflow.com/questions/533631/what-is-a-mixin-and-why-are-they-useful">Mixin</a> is a simple class that can be used to extend other classes either by overriding functionality of the base class or
by adding extra features. Django CBVs use various <a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/class-based-views/mixins/">mixins</a> to extend the base Views and add&nbsp;functionality.</p>
</div>
<div class="section" id="a-non-html-mixin">
<h2><a class="toc-backref" href="#id4">A non-<span class="caps">HTML</span>&nbsp;mixin</a></h2>
<p>So, a basic skeleton for our mixin would be something like&nbsp;this:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">NonHtmlResponseMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span> <span class="s">&quot;Hello, world&quot;</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>The previous mixin overrides the render_to_response method to just return the text &quot;Hello, world&quot;. For instance
we could define the following&nbsp;class:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">DummyTextResponseView</span><span class="p">(</span><span class="n">NonHtmlResponseMixin</span><span class="p">,</span> <span class="n">TemplateView</span><span class="p">,):</span>
  <span class="k">pass</span>
</pre></div>
<p>which can be added as a route to <tt class="docutils literal">urls.py</tt> (using the <tt class="docutils literal">as_view</tt> method) and will always return the &quot;Hello, world&quot;&nbsp;text.</p>
<p>Here&#8217;s something more complicated: A Mixin that can be used along with a DetailView and will output the properties of the
object as&nbsp;text:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">TextPropertiesResponseMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s">&#39;text/plain; charset=utf-8&#39;</span><span class="p">)</span>
      <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
      <span class="n">o</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span>
      <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
          <span class="n">response</span><span class="o">.</span><span class="n">write</span> <span class="p">(</span><span class="s">u&#39;{0}: {1}</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>  <span class="nb">unicode</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span> <span class="p">)</span> <span class="p">)</span>
      <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>and can be used like&nbsp;this</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">TextPropertiesDetailView</span><span class="p">(</span><span class="n">TextPropertiesResponseMixin</span><span class="p">,</span> <span class="n">FooDetailView</span><span class="p">,):</span>
  <span class="k">pass</span>
</pre></div>
<p>The above mixin will use the get_object() method of the DetailView to get the object and then output
it as text. We can create similar mixins that will integrate with other types of CBVs, for instance
to export a ListView as an <span class="caps">CSV</span> or generate an png from a DetailView of an Image&nbsp;file.</p>
</div>
<div class="section" id="a-more-complex-example">
<h2><a class="toc-backref" href="#id5">A more complex&nbsp;example</a></h2>
<p>The previous examples all built upon an existing view (either a TemplateView, a DetailView or a ListView).
However, an existing view that will fit our requirements won&#8217;t always be available. For instance,
sometimes I want to export data from my database using a raw <span class="caps">SQL</span> query. Also I&#8217;d like to be able to easily
export this data as csv or&nbsp;excel.</p>
<p>First of all, we need to define a view that will inherit from <tt class="docutils literal">View</tt> and export the data as a <span class="caps">CSV</span>:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">unicodecsv</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">View</span>

<span class="k">class</span> <span class="nc">CsvRawSqlExportView</span><span class="p">(</span><span class="n">View</span><span class="p">,</span> <span class="p">):</span>
  <span class="n">sql</span> <span class="o">=</span> <span class="s">&#39;select 1+1&#39;</span>
  <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;res&#39;</span><span class="p">]</span>
  <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">generate_data</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
              <span class="k">yield</span> <span class="n">row</span>

      <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
      <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sql</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
      <span class="n">generator</span> <span class="o">=</span> <span class="n">generate_data</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s">&#39;text/plain; charset=utf-8&#39;</span><span class="p">)</span>
      <span class="n">response</span><span class="p">[</span><span class="s">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;attachment; filename=export.csv&#39;</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">unicodecsv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="n">w</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">generator</span><span class="p">:</span>
          <span class="n">w</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>The above View has three attributes:
* sql, which is a string with the raw sql that will be executed
* headers, which is an array with the names of each header of the resulting data
* params, which is an array with parameters that may need to be passed to the&nbsp;query</p>
<p>The <tt class="docutils literal">get</tt> method executes the query and passes the result to <tt class="docutils literal">render_to_response</tt>
using a generator.  The <tt class="docutils literal">render_to_response</tt> method instantiates an HttpResponse
object with the correct attributes and writes the <span class="caps">CSV</span> to the response object using&nbsp;unicodecsv.</p>
<p>We can now quickly create a route that will export data from the users&nbsp;table:</p>
<div class="highlight"><pre><span class="n">url</span><span class="p">(</span>
    <span class="s">r&#39;^raw_export_users/$&#39;</span><span class="p">,</span>
    <span class="n">views</span><span class="o">.</span><span class="n">CsvRawSqlExportView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
        <span class="n">sql</span><span class="o">=</span><span class="s">&#39;select id, username from auth_user&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">]</span>
    <span class="p">)</span> <span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&#39;raw_export_users&#39;</span>
<span class="p">),</span>
</pre></div>
<p>If instead of <span class="caps">CSV</span> we wanted to export to <span class="caps">XLS</span> (using xlwt), we&#8217;d just need to create a&nbsp;Mixin:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">XlsRawSqlResponseMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generator</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
      <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s">&#39;application/ms-excel&#39;</span><span class="p">)</span>
      <span class="n">response</span><span class="p">[</span><span class="s">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;attachment; filename=export.xls&#39;</span>
      <span class="n">wb</span> <span class="o">=</span> <span class="n">xlwt</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">add_sheet</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">):</span>
              <span class="n">ws</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">generator</span><span class="p">):</span>
          <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
              <span class="n">ws</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>

      <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>and create a View that inherits from <tt class="docutils literal">CsvRawSqlExportView</tt> and uses the above&nbsp;mixin:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">XlsRawSqlExportView</span><span class="p">(</span> <span class="n">XlsRawSqlResponseMixin</span><span class="p">,</span> <span class="n">CsvRawSqlExportView</span> <span class="p">):</span>
  <span class="k">pass</span>
</pre></div>
<p>and route to that view to get the <span class="caps">XLS</span>:</p>
<div class="highlight"><pre><span class="n">url</span><span class="p">(</span>
    <span class="s">r&#39;^raw_export_users/$&#39;</span><span class="p">,</span>
    <span class="n">views</span><span class="o">.</span><span class="n">XlsRawSqlExportView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
        <span class="n">sql</span><span class="o">=</span><span class="s">&#39;select id, username from auth_user&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">]),</span>
    <span class="n">name</span><span class="o">=</span><span class="s">&#39;raw_export_users&#39;</span>
<span class="p">),</span>
</pre></div>
</div>
<div class="section" id="conclusion">
<h2><a class="toc-backref" href="#id6">Conclusion</a></h2>
<p>Using the above techniques we can define CBVs that will output their content in various content types
beyond <span class="caps">HTML</span>. This will help us write write clean and <span class="caps">DRY</span>&nbsp;code.</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2014/06/30/rest-flask-mongodb-heroku/">Implementing a simple, Heroku-hosted REST service using Flask and mongoDB</a>
      </h1>
      <p class="meta"><time datetime="2014-06-30T15:23:00" pubdate>Δευ 30 Ιούνιος 2014</time></p>
</header>

  <div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#requirements" id="id2">Requirements</a></li>
<li><a class="reference internal" href="#implementing-the-rest-service" id="id3">Implementing the <span class="caps">REST</span>&nbsp;service</a></li>
<li><a class="reference internal" href="#testing-it-locally" id="id4">Testing it&nbsp;locally</a></li>
<li><a class="reference internal" href="#deploying-to-heroku" id="id5">Deploying to&nbsp;Heroku</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>In the following, I will describe how I used <a class="reference external" href="http://flask.pocoo.org/">Flask</a>, a very nice web <em>microframework</em> for python along  with <a class="reference external" href="http://www.mongodb.org/">mongoDB</a>, the most
popular No-<span class="caps">SQL</span> database to implement a simple <span class="caps">REST</span> service that was hosted on <a class="reference external" href="https://dashboard.heroku.com/apps">Heroku</a>. This <span class="caps">REST</span> service would get readings from
a number of sensors from an Android&nbsp;device.</p>
<p>I chose Flask instead of Django mainly because the <span class="caps">REST</span> service that I needed to implement would be very simple and most of
the Django bells and whistles (<span class="caps">ORM</span>, auth, admin, etc) wouldn&#8217;t be needed anyway. Also, Flask is much quicker to set-up than
Django since almost everything (views, urls, etc) can be put inside one python&nbsp;module.</p>
<p>Concerning the choice of a NoSQL persistance solution (mongoDB), I wanted to have a table (or collection as it is called in the
mongoDB world) of readings from the sensor. Each reading would just have a timestamp and various other
arbitrary data depending on the type of the reading, so saving it as a <span class="caps">JSON</span> document in a NoSQL database is a good&nbsp;solution.</p>
<p>Finally, all the above will be deployed to Heroku which offers some great services for deploying python code in the&nbsp;cloud.</p>
</div>
<div class="section" id="requirements">
<h2><a class="toc-backref" href="#id2">Requirements</a></h2>
<p>I propose creating a file named <tt class="docutils literal">requirements.txt</tt> that will host the required packages for your project, so you will be
able to setup your projects after creating a virtual environment with <a class="reference external" href="http://virtualenv.readthedocs.org/en/latest/">virtualenv</a> just by running <tt class="docutils literal">pip install <span class="pre">-r</span> requirements.txt</tt>.
Also, the requirements.txt is required for deploying python to&nbsp;Heroku.</p>
<p>So, for my case, the contents of requirements.txt are the&nbsp;following:</p>
<pre class="code literal-block">
Flask==0.10.1
Flask-PyMongo==0.3.0
Flask-RESTful==0.2.12
Jinja2==2.7.3
MarkupSafe==0.23
Werkzeug==0.9.6
aniso8601==0.82
gunicorn==19.0.0
itsdangerous==0.24
pymongo==2.7.1
pytz==2014.4
six==1.7.2
</pre>
<ul class="simple">
<li>Flask-PyMongo is a simple wrapper for Flask around pymongo which is the python mongoDB&nbsp;driver.</li>
<li>Flask-RESTful is a simple library for creating <span class="caps">REST</span> APIs - it needs aniso8601 and&nbsp;pytz.</li>
<li>Jinja2 is the template library for Flask (we won&#8217;t use it but it is required by Flask installation) - it needs&nbsp;MarkupSafe.</li>
<li>Werkzeug is a <span class="caps">WSGI</span> utility library - required by&nbsp;Flask</li>
<li>gunicorn is a <span class="caps">WSGI</span> <span class="caps">HTTP</span> server - needed for deployment to&nbsp;Heroku</li>
<li>itsdangerous is used to sign data for usage in untrusted&nbsp;environments</li>
<li>six is the python 2/3 compatibility&nbsp;layer</li>
</ul>
</div>
<div class="section" id="implementing-the-rest-service">
<h2><a class="toc-backref" href="#id3">Implementing the <span class="caps">REST</span>&nbsp;service</a></h2>
<p>Instead of using just one single file for our Flask web application, we will create a python module to contain it and a
file named <tt class="docutils literal">runserver.py</tt> that will start a local development server to test&nbsp;it:</p>
<p>So, in the same folder as the <tt class="docutils literal">requirements.txt</tt> create a folder named <tt class="docutils literal">flask_rest_service</tt> and in there put
two files: <tt class="docutils literal">__init__.py</tt> and <tt class="docutils literal">resources.py</tt>.</p>
<p>The <tt class="docutils literal">__init__.py</tt> initializes our Flask application, our mongoDB connection and our Flask-RESTful&nbsp;api:</p>
<pre class="code literal-block">
import os
from flask import Flask
from flask.ext import restful
from flask.ext.pymongo import PyMongo
from flask import make_response
from bson.json_util import dumps

MONGO_URL = os.environ.get('MONGO_URL')
if not MONGO_URL:
    MONGO_URL = &quot;mongodb://localhost:27017/rest&quot;;

app = Flask(__name__)

app.config['MONGO_URI'] = MONGO_URL
mongo = PyMongo(app)

def output_json(obj, code, headers=None):
    resp = make_response(dumps(obj), code)
    resp.headers.extend(headers or {})
    return resp

DEFAULT_REPRESENTATIONS = {'application/json': output_json}
api = restful.Api(app)
api.representations = DEFAULT_REPRESENTATIONS

import flask_rest_service.resources
</pre>
<p>So what happens here? After the imports, we check if we have a MONGO_URL environment variable. This is
how we set options in Heroku. If such option does not exist in the environment then we are in our
development environment so we set it to the localhost (we must have a running mongoDB installation in
our dev&nbsp;environment).</p>
<p>In the next lines, we initialize our Flask application and our mongoDB connection (pymongo
uses a <tt class="docutils literal">MONGO_URI</tt> configuration option to know the database <span class="caps">URI</span>).</p>
<p>The <tt class="docutils literal">output_json</tt> is used to dump the <span class="caps">BSON</span> encoded mongoDB objects to <span class="caps">JSON</span> and was borrowed from
<a class="reference external" href="http://blog.alienretro.com/using-mongodb-with-flask-restful/">alienretro&#8217;s blog</a> &#8212; we initialize our restful <span class="caps">REST</span> <span class="caps">API</span> with this&nbsp;function.</p>
<p>Finally, we import the <tt class="docutils literal">resources.py</tt> module which actually defines our <span class="caps">REST</span>&nbsp;resources.</p>
<pre class="code literal-block">
import json
from flask import request, abort
from flask.ext import restful
from flask.ext.restful import reqparse
from flask_rest_service import app, api, mongo
from bson.objectid import ObjectId

class ReadingList(restful.Resource):
    def __init__(self, *args, **kwargs):
        self.parser = reqparse.RequestParser()
        self.parser.add_argument('reading', type=str)
        super(ReadingList, self).__init__()

    def get(self):
        return  [x for x in mongo.db.readings.find()]

    def post(self):
        args = self.parser.parse_args()
        if not args['reading']:
            abort(400)

        jo = json.loads(args['reading'])
        reading_id =  mongo.db.readings.insert(jo)
        return mongo.db.readings.find_one({&quot;_id&quot;: reading_id})


class Reading(restful.Resource):
    def get(self, reading_id):
        return mongo.db.readings.find_one_or_404({&quot;_id&quot;: reading_id})

    def delete(self, reading_id):
        mongo.db.readings.find_one_or_404({&quot;_id&quot;: reading_id})
        mongo.db.readings.remove({&quot;_id&quot;: reading_id})
        return '', 204


class Root(restful.Resource):
    def get(self):
        return {
            'status': 'OK',
            'mongo': str(mongo.db),
        }

api.add_resource(Root, '/')
api.add_resource(ReadingList, '/readings/')
api.add_resource(Reading, '/readings/&lt;ObjectId:reading_id&gt;')
</pre>
<p>Here we define three <tt class="docutils literal">Resource</tt> classes and add them to our previously defined <tt class="docutils literal">api</tt>: <tt class="docutils literal">Root</tt>, <tt class="docutils literal">Reading</tt> and <tt class="docutils literal">ReadingList</tt>.</p>
<p><tt class="docutils literal">Root</tt> just returns a dictionary with an <span class="caps">OK</span> status and some info on our mongodb&nbsp;connection.</p>
<p><tt class="docutils literal">Reading</tt> has gets an ObjectId
(which is the mongodb primary key) as a parameter and depending on the <span class="caps">HTTP</span> operation, it returns the reading with that
id when receiving an <tt class="docutils literal"><span class="caps">HTTP</span> <span class="caps">GET</span></tt> and deletes the reading with that id when receiving an <tt class="docutils literal"><span class="caps">HTTP</span> <span class="caps">DELETE</span></tt>.</p>
<p><tt class="docutils literal">ReadingList</tt> will return all readings when receiving an <tt class="docutils literal"><span class="caps">HTTP</span> <span class="caps">GET</span></tt> and will create a new reading when
receiving an <tt class="docutils literal"><span class="caps">HTTP</span> <span class="caps">POST</span></tt> The <tt class="docutils literal">post</tt> function uses the parser defined in <tt class="docutils literal">__init__</tt> which requires
a <tt class="docutils literal">reading</tt> parameter with the actual reading to be&nbsp;inserted.</p>
</div>
<div class="section" id="testing-it-locally">
<h2><a class="toc-backref" href="#id4">Testing it&nbsp;locally</a></h2>
<p>In order to run the development server, you will need to install and start mongodb locally which is beyond the scope of this post. After that
create a file named <tt class="docutils literal">runserver.py</tt> in the same folder as with the <tt class="docutils literal">requirements.txt</tt>
and the <tt class="docutils literal">flask_rest_service</tt> folder. The contents of this file should&nbsp;be:</p>
<pre class="code literal-block">
from flask_rest_service import app
app.run(debug=True)
</pre>
<p>When you run this file with <tt class="docutils literal">python runserver.py</tt> you should be able top visit your rest service at <a class="reference external" href="http://localhost:5000">http://localhost:5000</a> and get
an &quot;<span class="caps">OK</span>&quot;&nbsp;status.</p>
</div>
<div class="section" id="deploying-to-heroku">
<h2><a class="toc-backref" href="#id5">Deploying to&nbsp;Heroku</a></h2>
<p>To deploy to Heroku, you must create a <tt class="docutils literal">Procfile</tt> that contains the workers of your application. In our case, the
<tt class="docutils literal">Procfile</tt> should contain the&nbsp;following:</p>
<pre class="code literal-block">
web: gunicorn flask_rest_service:app
</pre>
<p>Also, you should add a .gitignore file with the&nbsp;following:</p>
<pre class="code literal-block">
*.pyc
</pre>
<p>Finally, to deploy your application to Heroku you can follow the instructions here: <a class="reference external" href="https://devcenter.heroku.com/articles/getting-started-with-python">https://devcenter.heroku.com/articles/getting-started-with-python</a>:</p>
<ul class="simple">
<li>Initialize a git repository and commit&nbsp;everything:</li>
</ul>
<pre class="code literal-block">
git init
git add .
git commit -m
</pre>
<ul class="simple">
<li>Create a new Heroku application (after logging in to heroku with <tt class="docutils literal">heroku login</tt>) and set the MONGO_URL environment variable (of course you have to obtain ths MONGO_URL variable for your heroku envirotnment by adding a mongoDB&nbsp;database):</li>
</ul>
<pre class="code literal-block">
heroku create
heroku config:set MONGO_URL=mongodb://user:pass&#64;mongoprovider.com:27409/rest
</pre>
<ul class="simple">
<li>And finally push your master branch to the heroku remote&nbsp;repository:</li>
</ul>
<pre class="code literal-block">
git push heroku master
</pre>
<p>If everything went ok you should be able to start a worker for your application, check that the worker is running, and finally visit&nbsp;it:</p>
<pre class="code literal-block">
heroku ps:scale web=1
heroku ps
heroku open
</pre>
<p>If everything was ok you should see an status-<span class="caps">OK</span> <span class="caps">JSON</span>&nbsp;!</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="http://spapas.github.io/2014/04/11/django-generic-formviews-for-objects/">Django generic FormViews for objects</a>
      </h1>
      <p class="meta"><time datetime="2014-04-11T10:23:00" pubdate>Παρ 11 Απρίλιος 2014</time></p>
</header>

  <div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#a-quick-introduction-to-the-formview" id="id2">A quick introduction to the <tt class="docutils literal">FormView</tt></a></li>
<li><a class="reference internal" href="#a-quick-introduction-to-the-singleobjectmixin" id="id3">A quick introduction to the <tt class="docutils literal">SingleObjectMixin</tt></a></li>
<li><a class="reference internal" href="#being-generic-and-dry" id="id4">Being generic and <span class="caps">DRY</span></a></li>
<li><a class="reference internal" href="#being-more-generic-and-dry" id="id5">Being more generic and <span class="caps">DRY</span></a></li>
<li><a class="reference internal" href="#other-options" id="id6">Other&nbsp;options</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1">Introduction</a></h2>
<p>We recently needed to create a number of views for changing the status of an Application model instance for our organization.
An Application model instance can be filled and then cancelled, submitted, acceptted etc - for each of these status changes a form should be
presented to the user. When the user submits the form the status of the Application will be&nbsp;changed.</p>
<p>To implement the above requirement we created a generic FormView that acts on the specific model instance. This
used two basic <span class="caps">CBV</span> components: The <tt class="docutils literal">FormView</tt> for the form manipulation and the <tt class="docutils literal">SingleObjectMixing</tt> for the
object&nbsp;handling.</p>
<p>Django <a class="reference external" href="https://docs.djangoproject.com/en/1.6/topics/class-based-views/">Class Based Views</a> (CBVs) can be used to create reusable Views using normal class inheritance. Most
people use the well-known <tt class="docutils literal">CreateView</tt>, <tt class="docutils literal">UpdateView</tt>, <tt class="docutils literal">DetailView</tt> and <tt class="docutils literal">ListView</tt>, however, as we
will see below, the <tt class="docutils literal">FormView</tt> will help us write <span class="caps">DRY</span>&nbsp;code.</p>
<p>I have to notice here that an invaluable tool to help you understanding CBVs is the <a class="reference external" href="http://ccbv.co.uk/"><span class="caps">CBV</span> inspector</a> which
has a nice web interface for browsing the <span class="caps">CBV</span> hierarchies, attributes and&nbsp;methods.</p>
</div>
<div class="section" id="a-quick-introduction-to-the-formview">
<h2><a class="toc-backref" href="#id2">A quick introduction to the <tt class="docutils literal">FormView</tt></a></h2>
<p>A simple <tt class="docutils literal">FormView</tt> can be defined like this (<a class="reference external" href="http://ccbv.co.uk/projects/Django/1.6/django.views.generic.edit/FormView/"><span class="caps">CBV</span> FormView</a>):</p>
<pre class="code literal-block">
class MyFormView(FormView):
  form_class = forms.MyFormView
  template_name = 'my_template.html'
</pre>
<p>The above can be used in urls.py like&nbsp;this:</p>
<pre class="code literal-block">
urlpatterns = patterns('',
  url(r'^my_formview/$', views.MyFormView.as_view() , name='my_formview' ),
</pre>
<p>This will present a form to the user when he visits the <tt class="docutils literal">my_formview</tt>  url &#8212; however this form won&#8217;t do anything. To allow
the form to actually do something when it&#8217;s been submitted we need to override the <tt class="docutils literal">form_valid</tt> method.</p>
<pre class="code literal-block">
def form_valid(self, form):
    value = form.cleaned_data['value']
    messages.info(self.request, &quot;MyForm submitted with value {0}!&quot;.format(value) )
    return HttpResponseRedirect( reverse('my_formview') )
</pre>
<p>As you can see the submitted form is passed in the method and can be used to receive its <tt class="docutils literal">cleaned_data</tt>. The <tt class="docutils literal">FormView</tt>
has various other options for instance a <tt class="docutils literal">form_invalid</tt> method, an <tt class="docutils literal">initial</tt> attribute to set the initial values for the form&nbsp;etc.</p>
</div>
<div class="section" id="a-quick-introduction-to-the-singleobjectmixin">
<h2><a class="toc-backref" href="#id3">A quick introduction to the <tt class="docutils literal">SingleObjectMixin</tt></a></h2>
<p>A <tt class="docutils literal">SingleObjectMixin</tt> adds a number of attributes <span class="amp">&amp;</span> methods to a view that can be used for object manipulation. The
most important ones is the <tt class="docutils literal">model</tt> and <tt class="docutils literal">queryset</tt> attributes and the <tt class="docutils literal">get_queryset</tt> and <tt class="docutils literal">get_object()</tt>. To use
the <tt class="docutils literal">SingleObjectMixin</tt> in your <span class="caps">CBV</span> just add it to the list of the classes to inherit from and define either the
<tt class="docutils literal">model</tt> or the <tt class="docutils literal">queryset</tt> attribute. After that you may pass a <tt class="docutils literal">pk</tt> parameter to your view and you will get an
<tt class="docutils literal">object</tt> context variable in the template with the selected&nbsp;object!</p>
</div>
<div class="section" id="being-generic-and-dry">
<h2><a class="toc-backref" href="#id4">Being generic and <span class="caps">DRY</span></a></h2>
<p>We can more or less now understand how we should use <tt class="docutils literal">FormView</tt> and <tt class="docutils literal">SingleObjectMixin</tt> to generate our
generic <tt class="docutils literal">FormView</tt> for acting on objects: Our <tt class="docutils literal">FormView</tt> should <em>get</em> the object using the <tt class="docutils literal">SingleObjectMixin</tt>
and change it when the form is submitted using the values from the form. A first implementation would be the&nbsp;following:</p>
<pre class="code literal-block">
class GenericObjectFormView1(FormView, SingleObjectMixin):

    def form_valid(self, form):
        obj = self.get_object()
        obj.change_status(form)
        return HttpResponseRedirect( obj.get_absolute_url() )
</pre>
<p>So our <tt class="docutils literal">GenericObjectFormView1</tt> class inherits from <tt class="docutils literal">FormView</tt> and <tt class="docutils literal">SingleObjectMixin</tt>. The only thing that we have
to assure is that the Model we want to act on needs to implement a <tt class="docutils literal">change_status</tt> method which gets the <tt class="docutils literal">form</tt> and
changes the status of that object based on its value. For instance, two implementations can be the&nbsp;following:</p>
<pre class="code literal-block">
class CancelObjectFormView(GenericObjectFormView1):
    template_name = 'cancel.html'
    form_class = forms.CancelForm
    model = models.Application

class SubmitObjectFormView(GenericObjectFormView1):
    template_name = 'submit.html'
    form_class = forms.SubmitForm
    model = models.Application
</pre>
</div>
<div class="section" id="being-more-generic-and-dry">
<h2><a class="toc-backref" href="#id5">Being more generic and <span class="caps">DRY</span></a></h2>
<p>The previous implementation has two&nbsp;problems:</p>
<ul class="simple">
<li>What happens if the status of the object should not be changed even if the form <em>is</em>&nbsp;valid?</li>
<li>We shouldn&#8217;t need to create a new template for every new <tt class="docutils literal">GenericObjectFormView</tt> since all these templates will just output the object information, ask a question for the status change and output the&nbsp;form.</li>
</ul>
<p>Let&#8217;s write a new version of our GenericObjectFormView that actually resolves&nbsp;these:</p>
<pre class="code literal-block">
class GenericObjectFormView2(FormView, SingleObjectMixin):
    template_name = 'generic_formview.html'
    ok_message = ''
    not_ok_message = ''
    title = ''
    question =''

    def form_valid(self, form):
        obj = self.get_object()
        r = obj.change_status(form)
        if r:
            messages.info(self.request, self.yes_message)
        else:
            messages.info(self.request, self.not_ok_message)
        return HttpResponseRedirect( obj.get_absolute_url() )

    def get_context_data(self, **kwargs):
        context = super(GenericYesNoFormView, self).get_context_data(**kwargs)
        context['title'] = self.title
        context['question'] = self.question
        return context
</pre>
<p>The above adds an ok and not ok message which will be outputed if the status can or cannot be changed. To accomplish this,
the <tt class="docutils literal">change_status</tt> method should now return a boolean value to mark if the action was ok or not. Also, a generic template
will now be used. This template has two placeholders: One for the title of the page (<tt class="docutils literal">title</tt> attribute) and one for the
question asked to the user (<tt class="docutils literal">question</tt> attribute). Now we can use it like&nbsp;this:</p>
<pre class="code literal-block">
class CancelObjectFormView(GenericObjectFormView2):
    form_class = forms.CancelForm
    model = models.Application
    ok_message = 'Cancel success!'
    not_ok_message = 'Not able to cancel!'
    title = 'Cancel an object'
    question = 'Do you want to cancel this object?'

class SubmitObjectFormView(GenericObjectFormView2):
    form_class = forms.SubmitForm
    model = models.Application
    ok_message = 'Submit  ok'
    not_ok_message = 'Cannot submit!'
    title = 'Submit an object'
    question ='Do you want to submit this object?'
</pre>
</div>
<div class="section" id="other-options">
<h2><a class="toc-backref" href="#id6">Other&nbsp;options</a></h2>
<p>We&#8217;ve just got a glimpse of how we can use CBVs to increase the DRYness of our Django applications. There are various
extra things that we can add to our <tt class="docutils literal">GenericObjectFormView2</tt> as attributes which will be defined by inheriting
classes. Some ideas is to check if the current user actually has access to modify the object (hint: override the
<tt class="docutils literal">get_object</tt> method of <tt class="docutils literal">SingleObjectMixin</tt>) or render the form diffirently depending on the current user (hint:
override the <tt class="docutils literal">get_form_kwargs</tt> method of <tt class="docutils literal">FormView</tt>).</p>
</div>
</div>
  		</article>
<div class="pagination">
    <a class="prev" href="http://spapas.github.io/author\serafeim-papastefanos2.html">&larr; Older</a>

  <br />
</div></div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="http://spapas.github.io/2014/12/16/change-bootstrap-material-primary-color/">Change the primary color of bootstrap material design</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2014/10/23/retrieve-gmail-blocked-attachments/">Retrieving Gmail blocked attachments</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2014/09/15/django-non-html-responses/">Django non-HTML responses</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2014/06/30/rest-flask-mongodb-heroku/">Implementing a simple, Heroku-hosted REST service using Flask and mongoDB</a>
      </li>
      <li class="post">
          <a href="http://spapas.github.io/2014/04/11/django-generic-formviews-for-objects/">Django generic FormViews for objects</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="http://spapas.github.io/category/css.html">css</a></li>
        <li><a href="http://spapas.github.io/category/django.html">django</a></li>
        <li><a href="http://spapas.github.io/category/flask.html">flask</a></li>
        <li><a href="http://spapas.github.io/category/git.html">git</a></li>
        <li><a href="http://spapas.github.io/category/pelican.html">pelican</a></li>
        <li><a href="http://spapas.github.io/category/python.html">python</a></li>
        <li><a href="http://spapas.github.io/category/spring.html">spring</a></li>
        <li><a href="http://spapas.github.io/category/wagtail.html">wagtail</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="http://spapas.github.io/tag/pelican.html">pelican</a>,    <a href="http://spapas.github.io/tag/google.html">google</a>,    <a href="http://spapas.github.io/tag/nodejs.html">node.js</a>,    <a href="http://spapas.github.io/tag/spring.html">spring</a>,    <a href="http://spapas.github.io/tag/rest.html">rest</a>,    <a href="http://spapas.github.io/tag/design.html">design</a>,    <a href="http://spapas.github.io/tag/gmail.html">gmail</a>,    <a href="http://spapas.github.io/tag/git.html">git</a>,    <a href="http://spapas.github.io/tag/java.html">java</a>,    <a href="http://spapas.github.io/tag/flask.html">flask</a>,    <a href="http://spapas.github.io/tag/less.html">less</a>,    <a href="http://spapas.github.io/tag/heroku.html">heroku</a>,    <a href="http://spapas.github.io/tag/forms.html">forms</a>,    <a href="http://spapas.github.io/tag/github-pages.html">github-pages</a>,    <a href="http://spapas.github.io/tag/ldap.html">ldap</a>,    <a href="http://spapas.github.io/tag/spring-security.html">spring-security</a>,    <a href="http://spapas.github.io/tag/css.html">css</a>,    <a href="http://spapas.github.io/tag/python.html">python</a>,    <a href="http://spapas.github.io/tag/mongodb.html">mongodb</a>,    <a href="http://spapas.github.io/tag/authentication.html">authentication</a>,    <a href="http://spapas.github.io/tag/class-based-views.html">class-based-views</a>,    <a href="http://spapas.github.io/tag/rst.html">rst</a>,    <a href="http://spapas.github.io/tag/branching.html">branching</a>,    <a href="http://spapas.github.io/tag/github.html">github</a>,    <a href="http://spapas.github.io/tag/windows.html">windows</a>,    <a href="http://spapas.github.io/tag/wagtail.html">wagtail</a>,    <a href="http://spapas.github.io/tag/django.html">django</a>,    <a href="http://spapas.github.io/tag/githubio.html">github.io</a>,    <a href="http://spapas.github.io/tag/static-html.html">static-html</a>,    <a href="http://spapas.github.io/tag/cbv.html">cbv</a>,    <a href="http://spapas.github.io/tag/security.html">security</a>,    <a href="http://spapas.github.io/tag/boostrap-material-design.html">boostrap-material-design</a>  </section>



</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2013-2014  - Serafeim Papastefanos -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44750952-1', 'auto');
    ga('send', 'pageview');
    </script>
	<script type="text/javascript">
	  var disqus_shortname = 'spapas-github-io';
	  (function() {
	    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	    dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
	    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	   })();
	</script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
</body>
</html>